server {
  server_name  _;  #default
  return 444;
}

server {
  server_name demo.alphagov.co.uk;
  listen 80;

  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_redirect off;

  rewrite /images/([a-zA-Z0-9-_]+)\.(png|jpg|gif|ico)/.*$ /images/$1.$2 last;
  rewrite /images/welcome/([a-zA-Z0-9-_]+)\.(png|jpg|gif|ico)/.*$ /images/welcome/$1.$2 last;
  rewrite /images/search/([a-zA-Z0-9-_]+)\.(png|jpg|gif|ico)/.*$ /images/search/$1.$2 last;
  rewrite /stylesheets/(.+)\.css/.*$ /stylesheets/$1.css last;
  rewrite /javascripts/(.*)\/(.*) /javascripts/$1 last;

  rewrite ^/smartanswers/$ /smartanswers/smartanswers/ last;
  rewrite ^/smartanswers/data/(.*) /smartanswers/smartanswers/data/$1 last;
  rewrite ^/smartanswers/js/smartanswers.js$ /smartanswers/smartanswers/js/smartanswers.js last;

  rewrite ^/(.*)/$ /$1 permanent;

  location /smartanswers {
    auth_basic            "Restricted";
    auth_basic_user_file  htpasswd;
    root /data/vhost/frontend.staging.alphagov.co.uk/current/public;
  }

  location /stylesheets {
    root /data/vhost/static.staging.alphagov.co.uk/current/public;
    expires max;
    add_header Vary Accept-Encoding;
    access_log  off;
  }

  location /javascripts {
    root /data/vhost/static.staging.alphagov.co.uk/current/public;
    expires max;
    add_header Vary Accept-Encoding;
    access_log  off;
  }

  location /images {
    root /data/vhost/static.staging.alphagov.co.uk/current/public;
    expires max;
    add_header Vary Accept-Encoding;
    access_log  off;
  }

  location / {
    auth_basic            "Restricted";
    auth_basic_user_file  htpasswd;
    proxy_cache demo;
    proxy_cache_valid 200 302 404 3m;
    proxy_pass http://127.0.0.1:8080;
  }

}
