#!/bin/bash
set -e
set -o pipefail

function error() {
  echo "UNKNOWN: Unable to read backup directories"
  exit 2
}
trap error ERR

count=0
message=""

dirs=$(find /data/backups/ -name BACKUPINFO)
for backupinfo in $dirs; do
   directory=${backupinfo%%/BACKUPINFO}
   date=`cat $backupinfo | sed -e 's/Date: //g'`
   today=`date +%s`; 
   backupdate=`date --date="$date" +%s`;
   age=$((($today - $backupdate)/60/60/24));
   if [ $age -gt 0 ]; then 
      message="${message}Backup of $directory last done $age days ago! ";
      count=$(($count + 1));
   fi;
done;

if [ $count -eq 0 ]; then
   echo "OK: All backups are less than a day old";
   exit 0;
else
   echo "WARNING: $message";
   exit 1;
fi
