keepalive_timeout 120;

proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-Server $host;
proxy_set_header X-Forwarded-Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_redirect off;
<% if @real_ip_header != '' -%>

# Use an unspoofable header from an upstream CDN or L7 load balancer.
real_ip_header <%= @real_ip_header -%>;
real_ip_recursive on;
set_real_ip_from 0.0.0.0/0;
<% end -%>

# Limit requests and connections based on $remote_addr.
# NB: This may not be accurate if there is a L3 load balancer upstream and
# real_ip_header cannot be set!
limit_req zone=rate burst=5 nodelay;
limit_conn connections 4;

proxy_read_timeout 20;

access_log /var/log/nginx/lb-access.log timed_combined;
access_log /var/log/nginx/lb-json.event.access.log json_event;
error_log  /var/log/nginx/lb-error.log;

<%
# TODO: These hashes can be removed with the feature flag `govuk_enable_router_redirects`
external_redirects = {
  # These redirects to external URLs are a last resort for any given problem.
  # Any additions should be cleared with Etienne. They are recorded here as
  # well for those without access to GitHub:
  # https://docs.google.com/a/digital.cabinet-office.gov.uk/document/d/1DJeKKnhmfQVJWhlwn0M7R5hSFy7t0kz-VJn2FqNSc7Y/edit
  '/cloudstore'                         => 'http://gcloud.civilservice.gov.uk/cloudstore/',
  '/digitalstrategy'                    => 'http://publications.cabinetoffice.gov.uk/digital/',
  '/performance/transactional-services' => 'http://transactionalservices.alphagov.co.uk/',
  '/support/internal'                   => "https://support.#{@app_domain}/",
  '/cabinet-office/sprint'              => 'http://digital.cabinetoffice.gov.uk/sprint-13/',
  '/cabinet-office/sprint13'            => 'http://digital.cabinetoffice.gov.uk/sprint-13/',
  '/paye-record-keeping'                => 'http://www.hmrc.gov.uk/payerti/payroll/record-keeping.htm',
  '/civilservicequarterly'              => 'https://quarterly.blog.gov.uk',
  '/devtracker'                         => 'http://devtracker.dfid.gov.uk/',
}

internal_redirects_case_insensitive = {
  # Use this sparingly where case-insensitivity is required for organisation
  # acronyms. Otherwise see internal_redirects further down.

  # Government department short URLs - Inside Government
  '/aaib'     => '/government/organisations/air-accidents-investigation-branch',
  '/accea'    => '/government/organisations/advisory-committee-on-clinical-excellence-awards',
  '/acco'     => '/government/organisations/advisory-committee-on-conscientious-objectors',
  '/acjp'     => '/government/organisations/advisory-committees-on-justices-of-the-peace',
  '/acl'      => '/government/organisations/advisory-council-on-libraries',
  '/acmd'     => '/government/organisations/advisory-council-on-the-misuse-of-drugs',
  '/acre'     => '/government/organisations/advisory-committee-on-releases-to-the-environment',
  '/afprb'    => '/government/organisations/armed-forces-pay-review-body',
  '/agmm'     => '/government/organisations/advisory-group-on-military-medicine',
  '/ago'      => '/government/organisations/attorney-generals-office',
  '/ahvla'    => '/government/organisations/animal-health-and-veterinary-laboratories-agency',
  '/alt'      => '/government/organisations/agricultural-land-tribunal',
  '/apc'      => '/government/organisations/animal-procedures-committee',
  '/awb'      => '/government/organisations/agricultural-wages-board',
  '/bis'      => '/government/organisations/department-for-business-innovation-skills',
  '/brac'     => '/government/organisations/building-regulations-advisory-committee',
  '/cac'      => '/government/organisations/central-arbitration-committee',
  '/ccrc'     => '/government/organisations/criminal-cases-review-commission',
  '/cfel'     => '/government/organisations/capital-for-enterprise-ltd',
  '/cfra'     => '/government/organisations/chief-fire-and-rescue-adviser-unit',
  '/ch'       => '/government/organisations/companies-house',
  '/chre'     => '/government/organisations/council-for-healthcare-regulatory-ce',
  '/cica'     => '/government/organisations/criminal-injuries-compensation-authority',
  '/cma'      => '/government/organisations/competition-and-markets-authority',
  '/corwm'    => '/government/organisations/committee-on-radioactive-waste-management',
  '/cs'       => '/government/organisations/competition-service',
  '/cst'      => '/government/organisations/council-for-science-and-technology',
  '/dbs'      => '/government/organisations/disclosure-and-barring-service',
  '/dclg'     => '/government/organisations/department-for-communities-and-local-government',
  '/dcms'     => '/government/organisations/department-for-culture-media-sport',
  '/decc'     => '/government/organisations/department-of-energy-climate-change',
  '/defra'    => '/government/organisations/department-for-environment-food-rural-affairs',
  '/des'      => '/government/organisations/defence-equipment-and-support',
  '/dfe'      => '/government/organisations/department-for-education',
  '/dfid'     => '/government/organisations/department-for-international-development',
  '/dft'      => '/government/organisations/department-for-transport',
  '/dh'       => '/government/organisations/department-of-health',
  '/dio'      => '/government/organisations/defence-infrastructure-organisation',
  '/dmo'      => '/government/organisations/uk-debt-management-office',
  '/dnsc'     => '/government/organisations/defence-nuclear-safety-committee',
  '/dpm'      => '/government/organisations/deputy-prime-ministers-office',
  '/dsa'      => '/government/organisations/driving-standards-agency',
  '/dsac'     => '/government/organisations/defence-scientific-advisory-council',
  '/dstl'     => '/government/organisations/defence-science-and-technology-laboratory',
  '/dvla'     => '/government/organisations/driver-and-vehicle-licensing-agency',
  '/dwp'      => '/government/organisations/department-for-work-pensions',
  '/efa'      => '/government/organisations/education-funding-agency',
  '/egac'     => '/government/organisations/export-guarantees-advisory-council',
  '/erg'      => '/government/organisations/efficiency-and-reform-group',
  '/fco'      => '/government/organisations/foreign-commonwealth-office',
  '/fpag'     => '/government/organisations/the-fuel-poverty-advisory-group',
  '/gad'      => '/government/organisations/government-actuary-s-department',
  '/gca'      => '/government/organisations/groceries-code-adjudicator',
  '/geo'      => '/government/organisations/government-equalities-office',
  '/gla'      => '/government/organisations/gangmasters-licensing-authority',
  '/gps'      => '/government/organisations/government-procurement-service',
  '/hca'      => '/government/organisations/homes-and-communities-agency',
  '/hmpo'     => '/government/organisations/hm-passport-office',
  '/hmrc'     => '/government/organisations/hm-revenue-customs',
  '/hs2'      => '/government/organisations/high-speed-two-limited',
  '/hsac'     => '/government/organisations/hazardous-substances-advisory-committee',
  '/hsac'     => '/government/organisations/advisory-committee-on-hazardous-substances',
  '/iaap'     => '/government/organisations/independent-agricultural-appeals-panel',
  '/idab'     => '/government/organisations/industrial-development-advisory-board',
  '/ilf'      => '/government/organisations/independent-living-fund',
  '/ipo'      => '/government/organisations/intellectual-property-office',
  '/ips'      => '/government/organisations/hm-passport-office',
  '/irc'      => '/government/organisations/insolvency-rules-committee',
  '/jfc'      => '/government/organisations/joint-forces-command',
  '/lpc'      => '/government/organisations/low-pay-commission',
  '/lrrc'     => '/government/organisations/land-registration-rule-committee',
  '/mac'      => '/government/organisations/migration-advisory-committee',
  '/maib'     => '/government/organisations/marine-accident-investigation-branch',
  '/mca'      => '/government/organisations/maritime-and-coastguard-agency',
  '/mdpga'    => '/government/organisations/ministry-of-defence-police-and-guarding-agency',
  '/mhra'     => '/government/organisations/medicines-and-healthcare-products-regulatory-agency',
  '/mmo'      => '/government/organisations/marine-management-organisation',
  '/mod'      => '/government/organisations/ministry-of-defence',
  '/moj'      => '/government/organisations/ministry-of-justice',
  '/nctl'     => '/government/organisations/national-college-for-teaching-and-leadership',
  '/neab'     => '/government/organisations/national-employer-advisory-board',
  '/nfa'      => '/government/organisations/national-fraud-authority',
  '/nio'      => '/government/organisations/northern-ireland-office',
  '/nlfab'    => '/government/organisations/nuclear-liabilities-financing-assurance-board',
  '/nmo'      => '/government/organisations/national-measurement-office',
  '/noms'     => '/government/organisations/national-offender-management-service',
  '/nrac'     => '/government/organisations/nuclear-research-advisory-council',
  '/oag'      => '/government/organisations/office-of-the-advocate-general-for-scotland',
  '/oda'      => '/government/organisations/olympic-delivery-authority',
  '/ofqual'   => '/government/organisations/office-of-qualifications-and-examinations-regulation',
  '/ofsted'   => '/government/organisations/ofsted',
  '/ofwat'    => '/government/organisations/the-water-services-regulation-authority',
  '/oisc'     => '/government/organisations/office-of-the-immigration-services-commissioner',
  '/old'      => '/government/organisations/olympic-lottery-distributor',
  '/olev'     => '/government/organisations/office-for-low-emission-vehicles',
  '/ols'      => '/government/organisations/office-for-life-sciences',
  '/ome'      => '/government/organisations/office-of-manpower-economics',
  '/opa'      => '/government/organisations/oil-and-pipelines-agency',
  '/opc'      => '/government/organisations/office-of-the-parliamentary-counsel',
  '/opg'      => '/government/organisations/office-of-the-public-guardian',
  '/ospt'     => '/government/organisations/official-solicitor-and-public-trustee',
  '/ots'      => '/government/organisations/office-of-tax-simplification',
  '/pabew'    => '/government/organisations/police-advisory-board-for-england-and-wales',
  '/phe'      => '/government/organisations/public-health-england',
  '/pins'     => '/government/organisations/planning-inspectorate',
  '/psrb'     => '/government/organisations/prison-services-pay-review-body',
  '/pvst'     => '/government/organisations/plant-varieties-and-seeds-tribunal',
  '/pwlb'     => '/government/organisations/public-works-loan-board',
  '/raib'     => '/government/organisations/rail-accidents-investigation-branch',
  '/rbgc'     => '/government/organisations/review-board-for-government-contracts',
  '/rmac'     => '/government/organisations/royal-mint-advisory-committee',
  '/rpa'      => '/government/organisations/rural-payments-agency',
  '/sac'      => '/government/organisations/science-advisory-council',
  '/sascmill' => '/government/organisations/science-advisory-committee-on-the-medical-implications-of-less-lethal-weapons',
  '/sce'      => '/government/organisations/service-children-s-education',
  '/sfa'      => '/government/organisations/skills-funding-agency',
  '/smcpc'    => '/government/organisations/social-mobility-and-child-poverty-commission',
  '/spva'     => '/government/organisations/service-personnel-and-veterans-agency',
  '/ssrb'     => '/government/organisations/review-body-on-senior-salaries',
  '/sta'      => '/government/organisations/standards-and-testing-agency',
  '/strb'     => '/government/organisations/school-teachers-review-body',
  '/svap'     => '/government/organisations/security-vetting-appeals-panel',
  '/tab'      => '/government/organisations/technical-advisory-board',
  '/tpc'      => '/government/organisations/tribunal-procedure-committee',
  '/tsb'      => '/government/organisations/technology-strategy-board',
  '/tsol'     => '/government/organisations/treasury-solicitor-s-department',
  '/ukaea'    => '/government/organisations/uk-atomic-energy-authority',
  '/ukba'     => '/government/organisations/uk-border-agency',
  '/ukces'    => '/government/organisations/uk-commission-for-employment-and-skills',
  '/ukfi'     => '/government/organisations/uk-financial-investments-limited',
  '/ukho'     => '/government/organisations/uk-hydrographic-office',
  '/ukti'     => '/government/organisations/uk-trade-investment',
  '/vapc'     => '/government/organisations/veterans-advisory-and-pensions-committees-x13',
  '/vca'      => '/government/organisations/vehicle-certification-agency',
  '/vmd'      => '/government/organisations/veterinary-medicines-directorate',
  '/voa'      => '/government/organisations/valuation-office-agency',
  '/vosa'     => '/government/organisations/vehicle-and-operator-services-agency',
  '/vpc'      => '/government/organisations/veterinary-products-committee',
  '/yjb'      => '/government/organisations/youth-justice-board-for-england-and-wales',
}

internal_redirects = {
  # These rewrites (FURLS) are for the purposes of URL Shortening. As
  # of 2013-10-26, redirect URLs at the root level need to be signed
  # off by James Thornett. If in doubt speak to your technical
  # architect.
  '/advancedlearningloans' => '/advanced-learning-loans',
  '/green-deal'            => '/green-deal-energy-saving-measures',
  '/green-deal-cashback'   => '/green-deal-energy-saving-measures/cashback-scheme',
  '/greendeal'             => '/green-deal-energy-saving-measures',
  '/greendealcashback'     => '/green-deal-energy-saving-measures/cashback-scheme',
  '/greendealCashback'     => '/green-deal-energy-saving-measures/cashback-scheme',
  '/studentfinance'        => '/student-finance',
  '/bookdrivingtest'       => '/book-practical-driving-test',
  '/booktheorytest'        => '/book-a-driving-theory-test',
  '/canceldrivingtest'     => '/cancel-practical-driving-test',
  '/canceltheorytest'      => '/cancel-driving-theory-test',
  '/changedrivingtest'     => '/change-date-practical-driving-test',
  '/changetheorytest'      => '/change-date-driving-theory-test',
  '/jsaonline'             => '/jobseekers-allowance/how-to-claim',
  '/courtclaims'           => '/make-court-claim-for-money',
  '/vehicleapproval'       => '/vehicle-approval',
  '/taxdisc'               => '/tax-disc',
  '/taxdisk'               => '/tax-disc',
  '/trailerconsent'        => '/permission-to-supply-a-large-goods-trailer-for-use-on-the-road',
  '/vic-locations'         => '/vehicle-identity-check-site',
  '/vic-apply'             => '/apply-for-a-vehicle-identity-check-vic',
  '/vehicle-recall'        => '/check-if-a-vehicle-has-been-recalled',
  '/minimumwage'           => '/national-minimum-wage',
  '/sorn'                  => '/register-sorn-statutory-off-road-notification',
  '/foreigntraveladvice'   => '/foreign-travel-advice',
  '/servicemanual'         => '/service-manual',
  '/universalcredit'       => '/universal-credit',
  '/uc'                    => '/universal-credit',
  '/uk-economy'            => '/government/topics/uk-economy',
  '/taxreturn'             => '/self-assessment-tax-returns',
  '/onlinetaxreturn'       => '/how-to-send-self-assessment-online',
  '/paytaxbill'            => '/pay-self-assessment-tax-bill',
  '/taxappeal'             => '/self-assessment-appeals',
  '/problempayingtax'      => '/difficulties-paying-hmrc',
  '/taxreturnforms'        => '/self-assessment-forms-and-helpsheets',
  '/taxstatement'          => '/understand-self-assessment-statement',
  '/businesstaxrecords'    => '/self-employed-records',
  '/registerforataxreturn' => '/register-for-self-assessment',
  '/406beacon'             => '/maritime-safety-weather-and-navigation/registering-406-mhz-beacons',
  '/consumer-rights'       => '/consumer-protection-rights',

  # Government department short URLs - Inside Government
  '/adjudicators-office'                => '/government/organisations/the-adjudicator-s-office',
  '/airports-commission'                => '/government/organisations/airports-commission',
  '/animals-in-science-committee'       => '/government/organisations/animals-in-science-committee',
  '/behavioural-insights-team'          => '/government/organisations/behavioural-insights-team',
  '/biometrics-commissioner'            => '/government/organisations/biometrics-commissioner',
  '/border-force'                       => '/government/organisations/border-force',
  '/british-hallmarking-council'        => '/government/organisations/british-hallmarking-council',
  '/ca-tribunal'                        => '/government/organisations/competition-appeal-tribunal',
  '/cabinet-office'                     => '/government/organisations/cabinet-office',
  '/cabinetoffice'                      => '/government/organisations/cabinet-office', # print campaign
  '/cac-pensions'                       => '/government/organisations/central-advisory-committee-on-pensions-and-compensation',
  '/certification-office'               => '/government/organisations/certification-office',
  '/charity-commission'                 => '/government/organisations/the-charity-commission-for-england-and-wales',
  '/chevening-foundation'               => '/government/organisations/chevening-foundation',
  '/childcare-business-grants'          => '/government/policies/creating-a-fairer-and-more-equal-society/supporting-pages/funding-a-grant-scheme-for-new-childcare-businesses',
  '/childrens-commissioner'             => '/government/organisations/office-of-the-children-s-commissioner',
  '/civil-procedure'                    => '/government/organisations/civil-procedure-rules-committee',
  '/coal'                               => '/government/organisations/the-coal-authority',
  '/commonwealth-scholarships'          => '/government/organisations/commonwealth-scholarship-commission-in-the-uk',
  '/communities'                        => '/government/organisations/department-for-communities-and-local-government',
  '/criminal-procedure'                 => '/government/organisations/criminal-procedure-rule-committee',
  '/dclg/staff-update'                  => '/government/organisations/department-for-communities-and-local-government/about/staff-update',
  '/dft/staff-update'                   => '/government/organisations/department-for-transport/about/staff-update',
  '/disclosure-barring-service'         => '/government/organisations/disclosure-and-barring-service',
  '/dwp/disabilityconfident'            => '/government/publications/employing-disabled-people-and-people-with-health-conditions/employing-disabled-people-and-people-with-health-conditions',
  '/environment-agency'                 => '/government/organisations/environment-agency',
  '/equality-2025'                      => '/government/organisations/equality-2025',
  '/family-procedure'                   => '/government/organisations/family-procedure-rule-committee',
  '/foreign-compensation-commission'    => '/government/organisations/foreign-compensation-commission',
  '/forensic-science-regulator'         => '/government/organisations/forensic-science-regulator',
  '/healthcareuk'                       => '/government/organisations/healthcare-uk',
  '/highways'                           => '/government/organisations/highways-agency',
  '/hm-courts-tribunals'                => '/government/organisations/hm-courts-and-tribunals-service',
  '/hm-passport-office'                 => '/government/organisations/hm-passport-office',
  '/hm-prison-service'                  => '/government/organisations/hm-prison-service',
  '/hm-treasury'                        => '/government/organisations/hm-treasury',
  '/home-office'                        => '/government/organisations/home-office',
  '/home-office/staff-update'           => '/government/organisations/home-office/about/staff-update',
  '/hs2growthtaskforce'                 => '/government/policy-advisory-groups/hs2-growth-taskforce',
  '/insolvency-service'                 => '/government/organisations/insolvency-service',
  '/ip-tribunal'                        => '/government/organisations/insolvency-practitioners-tribunal',
  '/judicial-ombudsman'                 => '/government/organisations/judicial-appointments-and-conduct-ombudsman',
  '/land-registry'                      => '/government/organisations/hm-land-registry',
  '/law-commission'                     => '/government/organisations/law-commission',
  '/leader-commons'                     => '/government/organisations/the-office-of-the-leader-of-the-house-of-commons',
  '/leader-lords'                       => '/government/organisations/office-of-the-leader-of-the-house-of-lords',
  '/monitor'                            => '/government/organisations/monitor',
  '/national-dna-database-ethics-group' => '/government/organisations/national-dna-database-ethics-group',
  '/national-fraud-authority'           => '/government/organisations/national-fraud-authority',
  '/natural-england'                    => '/government/organisations/natural-england',
  '/ndnad-ethics'                       => '/government/organisations/national-dna-database-ethics-group',
  '/nsandi'                             => '/government/organisations/national-security',
  '/number10'                           => '/government/organisations/prime-ministers-office-10-downing-street',
  '/office-for-life-sciences'           => '/government/organisations/office-for-life-sciences',
  '/parole-board'                       => '/government/organisations/parole-board',
  '/planning-inspectorate'              => '/government/organisations/planning-inspectorate',
  '/police-appeals'                     => '/government/organisations/police-discipline-appeals-tribunal',
  '/police-arbitration'                 => '/government/organisations/police-arbitration-tribunal',
  '/probation-trusts'                   => '/government/organisations/probation-trusts',
  '/public-standards'                   => '/government/organisations/the-committee-on-standards-in-public-life',
  '/royal-mint'                         => '/government/organisations/royal-mint',
  '/scotland-office'                    => '/government/organisations/scotland-office',
  '/surveillance-camera-commissioner'   => '/government/organisations/surveillance-camera-commissioner',
  '/teaching-agency'                    => '/government/organisations/national-college-for-teaching-and-leadership',
  '/traffic-commissioners'              => '/government/organisations/traffic-commissioners',
  '/transport'                          => '/government/organisations/department-for-transport',
  '/treasure-valuation'                 => '/government/organisations/treasure-valuation-committee',
  '/treasury'                           => '/government/organisations/hm-treasury',
  '/trust-ports'                        => '/government/organisations/trust-ports',
  '/uk-export-finance'                  => '/government/organisations/uk-export-finance',
  '/uk-space'                           => '/government/organisations/uk-space-agency',
  '/uk-visas-immigration'               => '/government/organisations/uk-visas-and-immigration',
  '/victims-commissioner'               => '/government/organisations/victims-commissioner',
  '/wales-office'                       => '/government/organisations/wales-office',

  # Inside Government - organisation sub-pages
  '/dsa/staff-update' => '/government/organisations/driving-standards-agency/about/staff-update',

  # Inside Government specific World Locations
  '/world'                              => '/government/world',
  '/world/bat'                          => '/government/world/british-antarctic-territory',
  '/world/bosnia-herzegovina'           => '/government/world/bosnia-and-herzegovina',
  '/world/cotedivoire'                  => '/government/world/cote-d-ivoire',
  '/world/council-of-europe'            => '/government/world/uk-delegation-to-council-of-europe',
  '/world/jerusalem'                    => '/government/world/the-occupied-palestinian-territories',
  '/world/oecd'                         => '/government/world/the-uk-permanent-delegation-to-the-oecd-organisation-for-economic-co-operation-and-development',
  '/world/osce'                         => '/government/world/uk-delegation-to-organization-for-security-and-co-operation-in-europe',
  '/world/southafrica'                  => '/government/world/south-africa',
  '/world/uk-eu'                        => '/government/world/uk-representation-to-the-eu',
  '/world/uk-nato'                      => '/government/world/uk-joint-delegation-to-nato',
  '/world/un-geneva'                    => '/government/world/uk-mission-to-the-un-geneva',
  '/world/un-newyork'                   => '/government/world/uk-mission-to-the-united-nations-new-york',
  '/world/un-vienna'                    => '/government/world/uk-mission-to-the-united-nations',

  # Inside Government homepage is now deprecated - redirect to main homepage
  '/government' => '/#departments-and-policy',


  # Government department promoted publications - Inside Government
  '/bis/financeguide'             => '/government/publications/sme-access-to-finance-schemes-measures-to-support-small-and-medium-sized-enterprise-growth',
  '/bis/industrial-strategy'      => '/government/policies/using-industrial-strategy-to-help-the-uk-economy-and-business-compete-and-grow',
  '/decc/green-deal-quick-guides' => '/government/organisations/department-of-energy-climate-change/series/green-deal-quick-guides',
  '/dft/hs2'                      => '/government/policies/developing-a-new-high-speed-rail-network',
  '/dft/twa'                      => '/government/organisations/department-for-transport/series/twa-inspector-reports-and-decision-letters',
  '/dio/sfa'                      => '/defence-infrastructure-organisation-service-family-accommodation',
  '/dwp/agepositive'              => '/government/organisations/department-for-work-pensions/series/age-positive',
  '/dwp/pip-toolkit'              => '/government/publications/the-personal-independence-payment-toolkit-for-partners/the-personal-independence-payment-pip-toolkit-for-partners',
  '/dwp/single-tier-pension'      => '/government/policies/making-the-state-pension-simpler-and-fairer',
  '/dwp/dwp040'                   => '/government/publications/your-state-pension-statement-explained-dwp040',
  '/dwp/cps5'                     => '/government/publications/your-state-pension-estimate-explained-cps5',
  '/dwp/cps5t'                    => '/government/publications/your-state-pension-estimate-explained-cps5t',
  '/fco/arab-partnership'         => '/government/policies/working-for-peace-and-long-term-stability-in-the-middle-east-and-north-africa/supporting-pages/the-arab-partnership',
  '/geo/body-confidence'          => '/government/policies/creating-a-fairer-and-more-equal-society/supporting-pages/body-confidence-campaign',
  '/geo/lgbt'                     => '/government/policies/creating-a-fairer-and-more-equal-society/supporting-pages/promoting-and-protecting-the-rights-of-lesbian-gay-bisexual-and-transgender-people',
  '/geo/thinkactreport'           => '/government/policies/creating-a-fairer-and-more-equal-society/supporting-pages/think-act-report',
  '/hmrc/glasgow2014'             => '/government/organisations/hm-revenue-customs/series/glasgow-2014-tax-exemption-for-non-resident-competitors',
  '/hmrc/graduates'               => '/tax-professional-development-programme',
  '/hmrc/your-charter'            => '/government/publications/your-charter',
  '/mod/staff-update'             => '/government/organisations/ministry-of-defence/about/staff-update',
  '/decc/eurogia'                 => '/innovation-funding-for-low-carbon-technologies-opportunities-for-bidders#european-collaboration-funding-schemes',
  '/dfe/nationalcurriculum'       => '/government/organisations/department-for-education/series/national-curriculum',

  # topical events (Olympics, G8 etc.)
  '/g8'                    => '/government/topical-events/g8-2013',
  '/somaliaconference2013' => '/government/topical-events/somalia-conference-2013',
  '/friendsofyemen2013'    => '/government/topical-events/friends-of-yemen-2013',
  '/ww1centenary'          => '/government/topical-events/first-world-war-centenary',
  '/spendinground2013'     => '/government/topical-events/spending-round-2013',
  '/fco/otjmc'             => '/government/topical-events/overseas-territories-joint-ministerial-council',

  # Direct request from Number 10 - Inside Government
  '/scotlandanalysis' => '/government/organisations/scotland-office/series/scotland-analysis',

  # This rewrite is for a printed URL which is very commonly misspelled
  '/renew-driving-license' => '/renew-driving-licence',

  # These rewrites are caused by content being relocated. They should be
  # amended by the person moving the content.
  '/additional-paternity-leave-pay-employees'           => '/employers-additional-paternity-pay-leave',
  '/additionalstatepension'                             => '/additional-state-pension',
  '/apply-renew-passport-abroad'                        => '/overseas-passports',
  '/applynationalinsurancenumber'                       => '/apply-national-insurance-number',
  '/arrest-imprison-abroad'                             => '/help-if-you-are-arrested-abroad',
  '/becoming-a-privately-owned-test-facility--2'        => '/becoming-a-privately-owned-test-facility',
  '/benefitsadviser'                                    => '/benefits-adviser',
  '/bmdcertificates'                                    => '/order-copy-birth-death-marriage-certificate',
  '/browse/births-deaths-marriages/registry-offices'    => '/browse/births-deaths-marriages/register-offices',
  '/browse/business'                                    => '/business',
  '/browse/citizenship/passports'                       => '/browse/abroad/passports',
  '/browse/driving/passports-travelling-abroad'         => '/browse/abroad',
  '/business-event-finder'                              => '/events-finder',
  '/business-training-and-networking-events-near-you'   => '/events-finder',
  '/calculate-child-maintenance'                        => '/calculate-your-child-maintenance',
  '/car-tax-disc-vehicle-licence'                       => '/tax-disc',
  '/change-name-address-vehicle-reg-certificate-v5c'    => '/change-name-address-v5c',
  '/change-photo-driving-licence'                       => '/renew-driving-licence',
  '/check-mot-status-vehicle'                           => '/check-mot-status',
  '/child-benefit-child-into-care'                      => '/child-benefit-for-children-in-hospital-or-care',
  '/child-benefit-hospital-residential-care'            => '/child-benefit-for-children-in-hospital-or-care',
  '/child-support-agency-employer-helpline'             => '/child-support-agency',
  '/community-legal-advice'                             => '/civil-legal-advice',
  '/complain-about-a-bankrupt'                          => '/complain-about-someone-bankrupt',
  '/copyofpolicerecords'                                => '/copy-of-police-records',
  '/council-tax-reduction/overview'                     => '/council-tax-reduction',
  '/criminal-records-bureau'                            => '/disclosure-barring-service-check/contact-disclosure-and-barring-service',
  '/driving-licence-application-identity-documents'     => '/id-for-driving-licence',
  '/driving-theory-practical-test-fees'                 => '/driving-test-cost',
  '/disclosure'                                         => '/dbs-update-service',
  '/disclosure-barring-service'                         => '/disclosure-barring-service-check/contact-disclosure-and-barring-service',
  '/employer-direct-online'                             => '/advertise-job',
  '/energyhelp'                                         => '/energy-grants-calculator',
  '/enterprisefinanceguarantee'                         => '/understanding-the-enterprise-finance-guarantee',
  '/edrf-low-carbon-grant'                              => '/erdf-low-carbon-grant',
  '/evicting-tenants-scotland'                          => '/tenancy-agreements-a-guide-for-landlords-scotland/ending-a-tenancy',
  '/exchange-paper-driving-licence-photocard-licence'   => '/exchange-paper-driving-licence',
  '/expenses-and-benefits-prizes-cash-prizes'           => '/expenses-and-benefits-cash-prizes',
  '/familyhistory'                                      => '/research-family-history',
  '/femalegenitalmutilation'                            => '/female-genital-mutilation',
  '/find-business-training-courses'                     => '/career-skills-and-training',
  '/find-your-national-insurance-number-if-its-lost'    => '/lost-national-insurance-number',
  '/findlostpension'                                    => '/find-lost-pension',
  '/fire-rescue-services'                               => '/financial-help-after-fire',
  '/forecasting-finances'                               => '/forecast-business-finances',
  '/foreign-and-commonwealth-office-travel-advice'      => '/foreign-travel-advice',
  '/freight-forwarders'                                 => '/freight-forwarding-moving-goods',
  '/gas-conveyance-licence-northern-ireland'            => '/gas-conveyance-storage-supply-ni',
  '/gas-storage-licence-northern-ireland'               => '/gas-conveyance-storage-supply-ni',
  '/gas-supply-licence-northern-ireland'                => '/gas-conveyance-storage-supply-ni',
  '/get-birthday-or-anniversary-message-from-the-queen' => '/get-birthday-anniversary-message-from-queen',
  '/getting-vehicle-back-if-its-been-wheel-clamped'     => '/get-a-clamped-or-impounded-vehicle-released',
  '/government/history/1-horse-guards'                  => '/government/history/1-horse-guards-road',
  '/government/ministers/minister-of-state--11'         => '/government/people/kris-hopkins',
  '/government/people/michael-spur'                     => '/government/people/michael-spurr',
  '/government/people/rita-kabaria-french'              => '/government/people/rita-french',
  '/government/topical-events/friends-of-yemen'         => '/government/topical-events/friends-of-yemen-2013',
  '/government/topical-events/somalia-conference'       => '/government/topical-events/somalia-conference-2013',
  '/government/world/jerusalem'                         => '/government/world/the-occupied-palestinian-territories',
  '/government/topics/economic-growth'                  => '/government/topics/uk-economy',
  '/government/topics/public-spending'                  => '/government/topics/government-spending',
  '/growing-a-business'                                 => '/growing-your-business',
  '/help/accessibility-policies'                        => '/help/accessibility',
  '/help/feedback'                                      => '/feedback',
  '/hysbysebu-swydd-gydag-universal-jobmatch'           => '/hysbysebu-swydd',
  '/importing-live-fish-molluscs-and-crustacea'         => '/importing-and-exporting-live-fish-molluscs-and-crustacea',
  '/increase-state-pension-age'                         => '/changes-state-pension',
  '/jobs-jobsearch'                                     => '/jobsearch',
  '/jobseeker-direct'                                   => '/jobsearch',
  '/legal-aid-eligibility-calculator'                   => '/check-legal-aid',
  '/lostnationalinsurancenumber'                        => '/lost-national-insurance-number',
  '/marriage-overseas'                                  => '/marriage-abroad',
  '/mot-test-fees'                                      => '/getting-an-mot/mot-test-fees',
  '/national-insurance-number'                          => '/apply-national-insurance-number',
  '/nipso-funds'                                        => '/nispo-funds',
  '/non-native-crayfish-and-lobster-deposits'           => '/non-native-fish-and-shellfish',
  '/non-native-fish'                                    => '/non-native-fish-and-shellfish',
  '/online-lasting-power-of-attorney'                   => '/lasting-power-of-attorney',
  '/personal-independence-payment'                      => '/pip',
  '/professional-and-career-development-loan-helpline'  => '/career-development-loans',
  '/regionalgrowthfund'                                 => '/regional-growth-fund-a-guide-for-small-and-medium-enterprises-smes',
  '/renew-your-driving-licence-if-you-are-70-or-over'   => '/renew-driving-licence-at-70',
  '/replace-child-trust-fund-voucher'                   => '/child-trust-funds',
  '/research-family-history-general-register-office'    => '/research-family-history',
  '/sleep-apnoea-and-driving'                           => '/obstructive-sleep-apnoea-and-driving',
  '/student-finance-evidence'                           => '/apply-for-student-finance',
  '/student-finance-evidence-from-parents-partners'     => '/apply-for-student-finance',
  '/support'                                            => '/help',
  '/support/about-govuk'                                => '/help/about-govuk',
  '/support/accessibility'                              => '/help/accessibility',
  '/support/accessibility-policies'                     => '/help/accessibility',
  '/support/apis'                                       => '/help',
  '/support/broken-pages'                               => '/help',
  '/support/browsers'                                   => '/help/browsers',
  '/support/cookies'                                    => '/help/cookies',
  '/support/directgov-businesslink'                     => '/help/about-govuk',
  '/support/government-gateway'                         => '/help',
  '/support/health'                                     => '/help',
  '/support/jobs-employment-tools'                      => '/help',
  '/support/linking-to-govuk'                           => '/help/about-govuk',
  '/support/privacy-policy'                             => '/help/privacy-policy',
  '/support/student-finance'                            => '/student-finance',
  '/support/terms-conditions'                           => '/help/terms-conditions',
  '/support/wales-scotland-ni'                          => '/help',
  '/taking-your-lorry-or-bus-abroad'                    => '/vehicle-documents-required-for-international-road-haulage',
  '/tell-us-once-report-death'                          => '/after-a-death',
  '/time-off-employment-hearing-tribunal'               => '/employment-tribunals/going-to-a-tribunal-hearing',
  '/track-your-passport-application'                    => '/track-passport-application',
  '/when-child-benefit-stops'                           => '/child-benefit-16-19',
  '/which-finance'                                      => '/business-finance-explained',
  '/who-can-sign-passport-driving-licence-applications' => '/countersigning-passport-applications',

  # separate alignment rules for massive URLs to follow
  '/accredited-electrical-and-electronic-equipment-producer-compliance-scheme-england-wales' => '/approved-eee-producer-compliance-scheme-england-wales',
  '/enhanced-capital-allowances-water-saving-investments' => '/enhanced-capital-allowances-energy-water',
  '/government/policies/stimulating-private-sector-investment-to-create-the-best-broadband-network-in-europe-by-2015' => '/government/policies/transforming-uk-broadband',
  '/service-manual/making-software/open-standards-and-licencing.html' => '/service-manual/making-software/open-standards-and-licensing.html',
  '/government/policies/providing-versatile-agile-and-battle-winning-armed-forces-and-a-smaller-more-professional-ministry-of-defence/supporting-pages/the-armed-forces-covenant' => '/government/policies/fulfilling-the-commitments-of-the-armed-forces-covenant',
  '/government/organisations/the-deputy-prime-ministers-office'      => '/government/organisations/deputy-prime-ministers-office',
  '/government/organisations/the-prime-ministers-office-number-10'   => '/government/organisations/prime-ministers-office-10-downing-street',
  '/government/organisations/export-credit-guarantee-department'     => '/government/organisations/uk-export-finance',
  '/government/organisations/teaching-agency'                        => '/government/organisations/national-college-for-teaching-and-leadership',
  '/government/organisations/national-college-for-school-leadership' => '/government/organisations/national-college-for-teaching-and-leadership',
  '/government/speeches/edward-timpson-speech-at-a-community-care-live-event-on-child-sexual-exploitation' => '/government/speeches/edward-timpson-speaks-to-the-community-care-live-conference-about-social-work-reform',
  '/former-users-of-internet-access-for-shared-services-iass'        => '/former-users-of-internet-access-to-shared-services-iass',
  '/arms-embargo-on-armenia-and-azerbaijan' => '/arms-embargo-on-armenia',
  '/government/publications/new-homes-bonus-grant-determination-2012-to-2013' => '/government/publications/new-homes-bonus-grant-determination',
  '/government/publications/bis-digital-stategy' => '/government/publications/bis-digital-strategy',
  '/government/publications/nhs-procurement-standards--2' => '/government/publications/nhs-procurement-standards',
  '/government/publications/uk-h2mmobility-potential-for-hydrogen-fuel-cell-electric-vehicles-phase-1-results' => '/government/publications/uk-h2mobility-potential-for-hydrogen-fuel-cell-electric-vehicles-phase-1-results',
  '/government/publications/service-personnel-and-veterans-agency-spva-annual-report-and-accounts-2009-and-2010-wrong-url-seems-to-have-been-included' => '/government/publications/service-personnel-and-veterans-agency-spva-annual-report-and-accounts-2009-and-2010',
  '/government/world/organisations/british-office-for-somalia/office/british-office-for-somalia' => '/government/world/organisations/british-embassy-mogadishu/office/british-embassy-mogadishu',

}

prefix_redirects = {
  # These rewrites are caused by content being relocated. They should be
  # amended by the person moving the content.
  '/24_advanced_learning_loans'                                => '/advanced-learning-loans',
  '/adoption-leave'                                            => '/adoption-pay-leave',
  '/adoption-leave-pay-employees'                              => '/employers-adoption-pay-leave',
  '/adoptionpay'                                               => '/statutory-adoption-pay',
  '/apply-council-tax-benefit'                                 => '/apply-council-tax-reduction',
  '/arranging-child-maintenance-child-support-agency'          => '/child-maintenance',
  '/boost-state-pension'                                       => '/national-insurance-credits',
  '/changes-affect-child-benefit'                              => '/child-benefit-child-parent-dies',
  '/child-benefit-child-not-living-with-you'                   => '/browse/benefits/child',
  '/childmaintenance'                                          => '/child-maintenance',
  '/childtrustfund'                                            => '/child-trust-funds',
  '/council-tax-benefit'                                       => '/council-tax-reduction',
  '/crb-criminal-records-bureau-check'                         => '/disclosure-barring-service-check',
  '/disabilitywork'                                            => '/looking-for-work-if-disabled',
  '/driving-if-disabled'                                       => '/driving-medical-conditions',
  '/driving-in-great-britain-on-non-gb-licence'                => '/non-gb-driving-licence',
  '/expenses-and-benefits-sporting-recreational-facilities'    => '/expenses-benefits-sporting-recreational-facilities',
  '/feed-in-tarriffs-money-for-generating-electricity'         => '/feed-in-tariffs',
  '/find-family-information-service'                           => '/find-registered-childminder',
  '/find-vosa-test-station'                                    => '/find-atf-vosa-test-station',
  '/find-your-nearest-vosa-test-station'                       => '/find-atf-vosa-test-station',
  '/government/organisations/identity-and-passport-service'    => '/government/organisations/hm-passport-office',
  '/government/world/organisations/british-office-for-somalia' => '/government/world/organisations/british-embassy-mogadishu',
  '/looking-for-work-if-youre-disabled'                        => '/looking-for-work-if-disabled',
  '/make-child-maintenance-deductions-employee-pay'            => '/child-maintenance-for-employers',
  '/maternity-benefits'                                        => '/calculate-your-maternity-pay',
  '/maternity-leave'                                           => '/maternity-pay-leave',
  '/maternity-leave-pay-employees'                             => '/employers-maternity-pay-leave',
  '/nationalinsurancecredits'                                  => '/national-insurance-credits',
  '/organise-fete-street-party'                                => '/organise-street-party',
  '/paternity-leave-pay-employees'                             => '/employers-paternity-pay-leave',
  '/paternity-pay'                                             => '/paternity-pay-leave',
  '/paternityleave'                                            => '/paternity-pay-leave',
  '/paye-forms-p45-p46-p60-p11d'                               => '/paye-forms-p45-p60-p11d',
  '/pensioncredit'                                             => '/pension-credit',
  '/sick-leave-pay-employees'                                  => '/employers-sick-pay',
  '/sickpay'                                                   => '/statutory-sick-pay',
  '/startup'                                                   => '/starting-up-a-business',
  '/statepension'                                              => '/state-pension',
  '/statutory-adoption-pay'                                    => '/adoption-pay-leave',
  '/statutory-maternity-pay'                                   => '/maternity-pay-leave',
  '/statutory-sick-pay-ssp'                                    => '/statutory-sick-pay',
  '/uk-welcomes-business'                                      => '/set-up-business-uk',
  '/voluntarynationalinsurance'                                => '/voluntary-national-insurance-contributions',
  '/which-finance-is-right-for-your-business'                  => '/business-finance-explained',
  '/your-right-to-minimum-wage'                                => '/national-minimum-wage',
}
%>
<% unless @enable_router -%>

# World Location regular expression
location /world/ {
  rewrite ^/world/([a-z0-9-]+)$ /government/world/$1 permanent;
}

<%- external_redirects.each do |from, to| -%>
location ~ ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 302 <%= to %>;
}
<%- end -%>

<%- internal_redirects_case_insensitive.each do |from, to| -%>
location ~* ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>;
}
<%- end -%>

<%- internal_redirects.each do |from, to| -%>
location ~ ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>;
}
<%- end -%>

<%- prefix_redirects.each do |from, to| -%>
location ~ ^<%= from %>($|/.*) {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>$1;
}
<%- end -%>
<% end # enable_router -%>

location @upstream {
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/? {
  proxy_intercept_errors off;

  # Set proxy timeout to 50 seconds as a quick fix for problems
  # where civica QueryPayments calls are taking too long.
  proxy_read_timeout 50;
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/assets/ {
  limit_req zone=rate burst=5 nodelay;
  limit_conn connections 25;
  proxy_pass http://varnish;
}

location ~ ^/performance/graphs/ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}
location ~ ^/performance/.+\.(json|png)$ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}

location / {
  root /var/www/fallback;

  <%- if @vhost_protected -%>

      deny all;
      auth_basic            "Enter the GOV.UK username/password (not your personal username/password)";
      auth_basic_user_file  /etc/govuk.htpasswd;
      satisfy any;

  <%- end -%>

  try_files /fallback.html @upstream;
}

error_page 404 401 /404.html;
error_page 406 /406.html;
error_page 410 /410.html;
error_page 418 /418.html;
error_page 500 502 /500.html;
error_page 503 /503.html;
error_page 504 /504.html;

# Serve a friendly error for rate limited requests. Maintains backwards
# compat because these previously emitted 503.
# FIXME: Mainstream to provide a new page for this.
error_page 429 /503.html;

location /404.html {
  root /usr/share/nginx/www;
  internal;
}
location /406.html {
  root /usr/share/nginx/www;
  internal;
}
location /410.html {
  root /usr/share/nginx/www;
  internal;
}
location /418.html {
  root /usr/share/nginx/www;
  internal;
}
location /500.html {
  root /usr/share/nginx/www;
  internal;
}
location /503.html {
  root /usr/share/nginx/www;
  internal;
}
location /504.html {
  root /usr/share/nginx/www;
  internal;
}
