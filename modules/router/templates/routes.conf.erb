keepalive_timeout 120;

proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-Server $host;
proxy_set_header X-Forwarded-Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_redirect off;

# This sets the IP used by Nginx to the client IP from the X-Forwarded-For
# chain, rather than the IP from the CDN node
real_ip_header X-Forwarded-For;
real_ip_recursive on;
set_real_ip_from 0.0.0.0/0;

# With the above real-ip in place we can limit connections and requests
# based on that
limit_req zone=rate burst=5 nodelay;
limit_conn connections 4;

proxy_read_timeout 10;

access_log /var/log/nginx/lb-access.log timed_combined;
access_log /var/log/nginx/lb-json.event.access.log json_event;
error_log  /var/log/nginx/lb-error.log;

<%- if @platform != 'production' -%>
deny all;
auth_basic            "Enter your username/password";
auth_basic_user_file  /etc/govuk.htpasswd;
satisfy any;
<%- end -%>

<%
external_redirects = {
  # These redirects to external URLs are a last resort for any given problem.
  # Any additions should be cleared with Etienne. They are recorded here as
  # well for those without access to GitHub:
  # https://docs.google.com/a/digital.cabinet-office.gov.uk/document/d/1DJeKKnhmfQVJWhlwn0M7R5hSFy7t0kz-VJn2FqNSc7Y/edit
  '/cloudstore'                         => 'http://gcloud.civilservice.gov.uk/cloudstore/',
  '/digitalstrategy'                    => 'http://publications.cabinetoffice.gov.uk/digital/',
  '/performance/transactional-services' => 'http://transactionalservices.alphagov.co.uk/',
  '/support/internal'                   => "https://support.#{@app_domain}/",
  '/cabinet-office/sprint'              => 'http://digital.cabinetoffice.gov.uk/sprint-13/',
  '/cabinet-office/sprint13'            => 'http://digital.cabinetoffice.gov.uk/sprint-13/',
}

internal_redirects = {
  # These rewrites (FURLS) are for the purposes of URL Shortening. As of
  # 2012-11-14 the process for adding this has not yet been clarified. If in
  # doubt, check with your Tech Arch.
  '/advancedlearningloans' => '/advanced-learning-loans',
  '/green-deal'            => '/green-deal-energy-saving-measures',
  '/green-deal-cashback'   => '/green-deal-energy-saving-measures/cashback-scheme',
  '/greendeal'             => '/green-deal-energy-saving-measures',
  '/greendealcashback'     => '/green-deal-energy-saving-measures/cashback-scheme',
  '/studentfinance'        => '/student-finance',
  '/bookdrivingtest'       => '/book-practical-driving-test',
  '/booktheorytest'        => '/book-a-driving-theory-test',
  '/canceldrivingtest'     => '/cancel-practical-driving-test',
  '/canceltheorytest'      => '/cancel-driving-theory-test',
  '/changedrivingtest'     => '/change-date-practical-driving-test',
  '/changetheorytest'      => '/change-date-driving-theory-test',
  '/jsaonline'             => '/jobseekers-allowance/how-to-claim',
  '/courtclaims'           => '/make-court-claim-for-money',
  '/vehicleapproval'       => '/vehicle-approval',
  '/trailerconsent'        => '/permission-to-supply-a-large-goods-trailer-for-use-on-the-road',
  '/vic-locations'         => '/vehicle-identity-check-site',
  '/vic-apply'             => '/apply-for-a-vehicle-identity-check-vic',
  '/vehicle-recall'        => '/check-if-a-vehicle-has-been-recalled',
  '/minimumwage'           => '/national-minimum-wage',
  '/sorn'                  => '/register-sorn-statutory-off-road-notification',
  '/foreigntraveladvice'   => '/foreign-travel-advice',
  '/servicemanual'         => '/service-manual',

  # Government department short URLs - Inside Government
  '/ago'                      => '/government/organisations/attorney-generals-office',
  '/airports-commission'      => '/government/organisations/airports-commission',
  '/bis'                      => '/government/organisations/department-for-business-innovation-skills',
  '/brac'                     => '/government/organisations/building-regulations-advisory-committee',
  '/cabinetoffice'            => '/government/organisations/cabinet-office', # print campaign
  '/cabinet-office'           => '/government/organisations/cabinet-office',
  '/communities'              => '/government/organisations/department-for-communities-and-local-government',
  '/dclg'                     => '/government/organisations/department-for-communities-and-local-government',
  '/dcms'                     => '/government/organisations/department-for-culture-media-sport',
  '/decc'                     => '/government/organisations/department-of-energy-climate-change',
  '/defra'                    => '/government/organisations/department-for-environment-food-rural-affairs',
  '/dfe'                      => '/government/organisations/department-for-education',
  '/dfid'                     => '/government/organisations/department-for-international-development',
  '/dft'                      => '/government/organisations/department-for-transport',
  '/dh'                       => '/government/organisations/department-of-health',
  '/dsa'                      => '/government/organisations/driving-standards-agency',
  '/dwp'                      => '/government/organisations/department-for-work-pensions',
  '/fco'                      => '/government/organisations/foreign-commonwealth-office',
  '/hmrc'                     => '/government/organisations/hm-revenue-customs',
  '/home-office'              => '/government/organisations/home-office',
  '/mod'                      => '/government/organisations/ministry-of-defence',
  '/moj'                      => '/government/organisations/ministry-of-justice',
  '/nio'                      => '/government/organisations/northern-ireland-office',
  '/oag'                      => '/government/organisations/office-of-the-advocate-general-for-scotland',
  '/office-for-life-sciences' => '/government/organisations/office-for-life-sciences',
  '/phe'                      => '/government/organisations/public-health-england',
  '/pins'                     => '/government/organisations/planning-inspectorate',
  '/planning-inspectorate'    => '/government/organisations/planning-inspectorate',
  '/scotland-office'          => '/government/organisations/scotland-office',
  '/transport'                => '/government/organisations/department-for-transport',
  '/treasury'                 => '/government/organisations/hm-treasury',
  '/wales-office'             => '/government/organisations/wales-office',

  # Government department promoted publications - Inside Government
  '/dft/hs2'                      => '/government/policies/developing-a-new-high-speed-rail-network',
  '/decc/green-deal-quick-guides' => '/government/organisations/department-of-energy-climate-change/series/green-deal-quick-guides',

  # topical events (Olympics, G8 etc.)
  '/g8'                    => '/government/topical-events/g8-2013',
  '/somaliaconference2013' => '/government/topical-events/somalia-conference-2013',
  '/friendsofyemen2013'    => '/government/topical-events/friends-of-yemen-2013',

  # Direct request from Number 10 - Inside Government
  '/scotlandanalysis' => '/government/organisations/scotland-office/series/scotland-analysis',

  # These rewrites are caused by content being relocated. They should be
  # amended by the person moving the content.
  '/browse/births-deaths-marriages/registry-offices'    => '/browse/births-deaths-marriages/register-offices',
  '/calculate-child-maintenance'                        => '/calculate-your-child-maintenance',
  '/child-support-agency-employer-helpline'             => '/child-support-agency',
  '/employer-direct-online'                             => '/advertise-job',
  '/growing-a-business'                                 => '/growing-your-business',
  '/jobseeker-direct'                                   => '/jobsearch',
  '/personal-independence-payment'                      => '/pip',
  '/tell-us-once-report-death'                          => '/after-a-death',
  '/business-event-finder'                              => '/events-finder',
  '/business-training-and-networking-events-near-you'   => '/events-finder',
  '/complain-about-a-bankrupt'                          => '/complain-about-someone-bankrupt',
  '/expenses-and-benefits-prizes-cash-prizes'           => '/expenses-and-benefits-cash-prizes',
  '/forecasting-finances'                               => '/forecast-business-finances',
  '/replace-child-trust-fund-voucher'                   => '/child-trust-funds',
  '/jobs-jobsearch'                                     => '/jobsearch',
  '/which-finance'                                      => '/which-finance-is-right-for-your-business',
  '/research-family-history-general-register-office'    => '/research-family-history',
  '/familyhistory'                                      => '/research-family-history',
  '/bmdcertificates'                                    => '/order-copy-birth-death-marriage-certificate',
  '/benefitsadviser'                                    => '/benefits-adviser',
  '/increase-state-pension-age'                         => '/changes-state-pension',
  '/additionalstatepension'                             => '/additional-state-pension',
  '/findlostpension'                                    => '/find-lost-pension',
  '/national-insurance-number'                          => '/apply-national-insurance-number',
  '/applynationalinsurancenumber'                       => '/apply-national-insurance-number',
  '/find-your-national-insurance-number-if-its-lost'    => '/lost-national-insurance-number',
  '/lostnationalinsurancenumber'                        => '/lost-national-insurance-number',
  '/car-tax-disc-vehicle-licence'                       => '/tax-disc',
  '/taxdisc'                                            => '/tax-disc',
  '/driving-theory-practical-test-fees'                 => '/driving-test-cost',
  '/freight-forwarders'                                 => '/freight-forwarding-moving-goods',
  '/student-finance-evidence-from-parents-partners'     => '/apply-for-student-finance',
  '/student-finance-evidence'                           => '/apply-for-student-finance',
  '/fire-rescue-services'                               => '/financial-help-after-fire',
  '/change-photo-driving-licence'                       => '/renew-driving-licence',
  '/apply-renew-passport-abroad'                        => '/overseas-passports',
  '/who-can-sign-passport-driving-licence-applications' => '/countersigning-passport-applications',
  '/energyhelp'                                         => '/energy-grants-calculator',
  '/non-native-fish'                                    => '/non-native-fish-and-shellfish',
  '/non-native-crayfish-and-lobster-deposits'           => '/non-native-fish-and-shellfish',
  '/importing-live-fish-molluscs-and-crustacea'         => '/importing-and-exporting-live-fish-molluscs-and-crustacea',
  '/government/topical-events/somalia-conference'       => '/government/topical-events/somalia-conference-2013',
  '/government/topical-events/friends-of-yemen'         => '/government/topical-events/friends-of-yemen-2013',

  # separate alignment rules for massive URL to follow
  '/government/policies/stimulating-private-sector-investment-to-create-the-best-broadband-network-in-europe-by-2015' => '/government/policies/transforming-uk-broadband',
}

prefix_redirects = {
  # These rewrites are caused by content being relocated. They should be
  # amended by the person moving the content.
  '/arranging-child-maintenance-child-support-agency'       => '/child-maintenance',
  '/childmaintenance'                                       => '/child-maintenance',
  '/make-child-maintenance-deductions-employee-pay'         => '/child-maintenance-for-employers',
  '/expenses-and-benefits-sporting-recreational-facilities' => '/expenses-benefits-sporting-recreational-facilities',
  '/organise-fete-street-party'                             => '/organise-street-party',
  '/startup'                                                => '/starting-up-a-business',
  '/childtrustfund'                                         => '/child-trust-funds',
  '/statepension'                                           => '/state-pension',
  '/statutory-sick-pay-ssp'                                 => '/statutory-sick-pay',
  '/sickpay'                                                => '/statutory-sick-pay',
  '/pensioncredit'                                          => '/pension-credit',
  '/boost-state-pension'                                    => '/national-insurance-credits',
  '/nationalinsurancecredits'                               => '/national-insurance-credits',
  '/voluntarynationalinsurance'                             => '/voluntary-national-insurance-contributions',
  '/adoptionpay'                                            => '/statutory-adoption-pay',
  '/looking-for-work-if-youre-disabled'                     => '/looking-for-work-if-disabled',
  '/disabilitywork'                                         => '/looking-for-work-if-disabled',
  '/feed-in-tarriffs-money-for-generating-electricity'      => '/feed-in-tariffs',
  '/driving-if-disabled'                                    => '/driving-medical-conditions',
  '/24_advanced_learning_loans'                             => '/advanced-learning-loans',
  '/your-right-to-minimum-wage'                             => '/national-minimum-wage',
}
%>

<%- external_redirects.each do |from, to| -%>
location ~ ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 302 <%= to %>;
}
<%- end -%>

<%- internal_redirects.each do |from, to| -%>
location ~ ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>;
}
<%- end -%>

<%- prefix_redirects.each do |from, to| -%>
location ~ ^<%= from %>($|/.*) {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>$1;
}
<%- end -%>

location @upstream {
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/ {
  proxy_intercept_errors off;

  # Set proxy timeout to 50 seconds as a quick fix for problems
  # where civica QueryPayments calls are taking too long.
  proxy_read_timeout 50;
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/assets/ {
  limit_req zone=rate burst=5 nodelay;
  limit_conn connections 25;
  proxy_pass http://varnish;
}

location ~ ^/performance/graphs/ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}
location ~ ^/performance/.+\.(json|png)$ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}

# Start Inside Gov password logic:
#
# This whole government block is so we can hide the remaining undeployed parts
# of Inside Gov.
location ~ ^/government/world(?!.*\.atom$).*$ {
  # XXX: If you remove this password control remove the cache control below too!
  deny all;
  auth_basic           "This part of INSIDE GOVERNMENT is not currently public. Government employees please login:";
  auth_basic_user_file /etc/govuk.htpasswd;
  satisfy any;
  proxy_pass http://varnish;

  # This is for Akamai and is part of the password above: If you remove the
  # passwd, remove this cache control as well!
  add_header cache-control no-cache;
}
# End Inside Gov password logic

# Akamai CDN test object. This file is used by Akamai's infrastructure to
# determine optimal routing within their network. It can be any text file
# 8-12KiB in size.
location = /__testobj__ {
  root /var/www;
  try_files /akamai_test_object.txt =404;
}

location / {
  root /var/www/fallback;

  <%- if @vhost_protected -%>

      deny all;
      auth_basic            "Enter your betademo password";
      auth_basic_user_file  /etc/govuk.htpasswd;
      satisfy any;

  <%- end -%>

  try_files /fallback.html /flatsite/$uri /flatsite/$uri.html /flatsite/$uri/ /flatsite/$uri.1.html /flatsite/$uri/index.html /flatsite/index.html @upstream;
}

error_page 404 401 /404.html;
error_page 406 /406.html;
error_page 410 /410.html;
error_page 418 /418.html;
error_page 500 502 /500.html;
error_page 503 /503.html;
error_page 504 /504.html;

location /404.html {
  root /usr/share/nginx/www;
  internal;
}
location /406.html {
  root /usr/share/nginx/www;
  internal;
}
location /410.html {
  root /usr/share/nginx/www;
  internal;
}
location /418.html {
  root /usr/share/nginx/www;
  internal;
}
location /500.html {
  root /usr/share/nginx/www;
  internal;
}
location /503.html {
  root /usr/share/nginx/www;
  internal;
}
location /504.html {
  root /usr/share/nginx/www;
  internal;
}
