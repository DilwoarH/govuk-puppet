keepalive_timeout 120;

proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-Server $host;
proxy_set_header X-Forwarded-Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_redirect off;

# This sets the IP used by Nginx to the client IP from the X-Forwarded-For
# chain, rather than the IP from the CDN node
real_ip_header X-Forwarded-For;
real_ip_recursive on;
set_real_ip_from 0.0.0.0/0;

# With the above real-ip in place we can limit connections and requests
# based on that
limit_req zone=rate burst=5 nodelay;
limit_conn connections 4;

proxy_read_timeout 20;

access_log /var/log/nginx/lb-access.log timed_combined;
access_log /var/log/nginx/lb-json.event.access.log json_event;
error_log  /var/log/nginx/lb-error.log;

<%
external_redirects = {
  # These redirects to external URLs are a last resort for any given problem.
  # Any additions should be cleared with Etienne. They are recorded here as
  # well for those without access to GitHub:
  # https://docs.google.com/a/digital.cabinet-office.gov.uk/document/d/1DJeKKnhmfQVJWhlwn0M7R5hSFy7t0kz-VJn2FqNSc7Y/edit
  '/cloudstore'                         => 'http://gcloud.civilservice.gov.uk/cloudstore/',
  '/digitalstrategy'                    => 'http://publications.cabinetoffice.gov.uk/digital/',
  '/performance/transactional-services' => 'http://transactionalservices.alphagov.co.uk/',
  '/support/internal'                   => "https://support.#{@app_domain}/",
  '/cabinet-office/sprint'              => 'http://digital.cabinetoffice.gov.uk/sprint-13/',
  '/cabinet-office/sprint13'            => 'http://digital.cabinetoffice.gov.uk/sprint-13/',
  '/paye-record-keeping'                => 'http://www.hmrc.gov.uk/payerti/payroll/record-keeping.htm',
}

internal_redirects = {
  # These rewrites (FURLS) are for the purposes of URL Shortening. As of
  # 2012-11-14 the process for adding this has not yet been clarified. If in
  # doubt, check with your Tech Arch.
  '/advancedlearningloans' => '/advanced-learning-loans',
  '/green-deal'            => '/green-deal-energy-saving-measures',
  '/green-deal-cashback'   => '/green-deal-energy-saving-measures/cashback-scheme',
  '/greendeal'             => '/green-deal-energy-saving-measures',
  '/greendealcashback'     => '/green-deal-energy-saving-measures/cashback-scheme',
  '/studentfinance'        => '/student-finance',
  '/bookdrivingtest'       => '/book-practical-driving-test',
  '/booktheorytest'        => '/book-a-driving-theory-test',
  '/canceldrivingtest'     => '/cancel-practical-driving-test',
  '/canceltheorytest'      => '/cancel-driving-theory-test',
  '/changedrivingtest'     => '/change-date-practical-driving-test',
  '/changetheorytest'      => '/change-date-driving-theory-test',
  '/jsaonline'             => '/jobseekers-allowance/how-to-claim',
  '/courtclaims'           => '/make-court-claim-for-money',
  '/vehicleapproval'       => '/vehicle-approval',
  '/taxdisc'               => '/tax-disc',
  '/taxdisk'               => '/tax-disc',
  '/trailerconsent'        => '/permission-to-supply-a-large-goods-trailer-for-use-on-the-road',
  '/vic-locations'         => '/vehicle-identity-check-site',
  '/vic-apply'             => '/apply-for-a-vehicle-identity-check-vic',
  '/vehicle-recall'        => '/check-if-a-vehicle-has-been-recalled',
  '/minimumwage'           => '/national-minimum-wage',
  '/sorn'                  => '/register-sorn-statutory-off-road-notification',
  '/foreigntraveladvice'   => '/foreign-travel-advice',
  '/servicemanual'         => '/service-manual',
  '/universalcredit'       => '/universal-credit',
  '/uc'                    => '/universal-credit',

  # Government department short URLs - Inside Government
  '/aaib'                             => '/government/organisations/air-accidents-investigation-branch',
  '/acco'                             => '/government/organisations/advisory-committee-on-conscientious-objectors',
  '/acjp'                             => '/government/organisations/advisory-committees-on-justices-of-the-peace',
  '/acl'                              => '/government/organisations/advisory-council-on-libraries',
  '/acmd'                             => '/government/organisations/advisory-council-on-the-misuse-of-drugs',
  '/acre'                             => '/government/organisations/advisory-committee-on-releases-to-the-environment',
  '/adjudicators-office'              => '/government/organisations/the-adjudicator-s-office',
  '/afprb'                            => '/government/organisations/armed-forces-pay-review-body',
  '/agmm'                             => '/government/organisations/advisory-group-on-military-medicine',
  '/ago'                              => '/government/organisations/attorney-generals-office',
  '/ahvla'                            => '/government/organisations/animal-health-and-veterinary-laboratories-agency',
  '/airports-commission'              => '/government/organisations/airports-commission',
  '/alt'                              => '/government/organisations/agricultural-land-tribunal',
  '/apc'                              => '/government/organisations/animal-procedures-committee',
  '/awb'                              => '/government/organisations/agricultural-wages-board',
  '/behavioural-insights-team'        => '/government/organisations/behavioural-insights-team',
  '/bis'                              => '/government/organisations/department-for-business-innovation-skills',
  '/brac'                             => '/government/organisations/building-regulations-advisory-committee',
  '/british-hallmarking-council'      => '/government/organisations/british-hallmarking-council',
  '/ca-tribunal'                      => '/government/organisations/competition-appeal-tribunal',
  '/cabinet-office'                   => '/government/organisations/cabinet-office',
  '/cabinetoffice'                    => '/government/organisations/cabinet-office', # print campaign
  '/cac'                              => '/government/organisations/central-arbitration-committee',
  '/cac-pensions'                     => '/government/organisations/central-advisory-committee-on-pensions-and-compensation',
  '/ccrc'                             => '/government/organisations/criminal-cases-review-commission',
  '/certification-office'             => '/government/organisations/certification-office',
  '/cfel'                             => '/government/organisations/capital-for-enterprise-ltd',
  '/ch'                               => '/government/organisations/companies-house',
  '/charity-commission'               => '/government/organisations/the-charity-commission-for-england-and-wales',
  '/chevening-foundation'             => '/government/organisations/chevening-foundation',
  '/childcare-business-grants'        => '/government/policies/creating-a-fairer-and-more-equal-society/supporting-pages/funding-a-grant-scheme-for-new-childcare-businesses',
  '/childrens-commissioner'           => '/government/organisations/office-of-the-children-s-commissioner',
  '/chre'                             => '/government/organisations/council-for-healthcare-regulatory-ce',
  '/cica'                             => '/government/organisations/criminal-injuries-compensation-authority',
  '/civil-procedure'                  => '/government/organisations/civil-procedure-rules-committee',
  '/coal'                             => '/government/organisations/the-coal-authority',
  '/commonwealth-scholarships'        => '/government/organisations/commonwealth-scholarship-commission-in-the-uk',
  '/communities'                      => '/government/organisations/department-for-communities-and-local-government',
  '/corwm'                            => '/government/organisations/committee-on-radioactive-waste-management',
  '/criminal-procedure'               => '/government/organisations/criminal-procedure-rule-committee',
  '/cs'                               => '/government/organisations/competition-service',
  '/cst'                              => '/government/organisations/council-for-science-and-technology',
  '/dbs'                              => '/government/organisations/disclosure-and-barring-service',
  '/dclg'                             => '/government/organisations/department-for-communities-and-local-government',
  '/dclg/staff-update'                => '/government/organisations/department-for-communities-and-local-government/about/staff-update',
  '/dcms'                             => '/government/organisations/department-for-culture-media-sport',
  '/decc'                             => '/government/organisations/department-of-energy-climate-change',
  '/defra'                            => '/government/organisations/department-for-environment-food-rural-affairs',
  '/des'                              => '/government/organisations/defence-equipment-and-support',
  '/dfe'                              => '/government/organisations/department-for-education',
  '/dfid'                             => '/government/organisations/department-for-international-development',
  '/dft'                              => '/government/organisations/department-for-transport',
  '/dft/staff-update'                 => '/government/organisations/department-for-transport/about/staff-update',
  '/dh'                               => '/government/organisations/department-of-health',
  '/dio'                              => '/government/organisations/defence-infrastructure-organisation',
  '/dmo'                              => '/government/organisations/uk-debt-management-office',
  '/dnsc'                             => '/government/organisations/defence-nuclear-safety-committee',
  '/dpm'                              => '/government/organisations/deputy-prime-ministers-office',
  '/dsa'                              => '/government/organisations/driving-standards-agency',
  '/dsac'                             => '/government/organisations/defence-scientific-advisory-council',
  '/dstl'                             => '/government/organisations/defence-science-and-technology-laboratory',
  '/dvla'                             => '/government/organisations/driver-and-vehicle-licensing-agency',
  '/dwp'                              => '/government/organisations/department-for-work-pensions',
  '/efa'                              => '/government/organisations/education-funding-agency',
  '/egac'                             => '/government/organisations/export-guarantees-advisory-council',
  '/environment-agency'               => '/government/organisations/environment-agency',
  '/equality-2025'                    => '/government/organisations/equality-2025',
  '/erg'                              => '/government/organisations/efficiency-and-reform-group',
  '/family-procedure'                 => '/government/organisations/family-procedure-rule-committee',
  '/fco'                              => '/government/organisations/foreign-commonwealth-office',
  '/foreign-compensation-commission'  => '/government/organisations/foreign-compensation-commission',
  '/fpag'                             => '/government/organisations/the-fuel-poverty-advisory-group',
  '/gad'                              => '/government/organisations/government-actuary-s-department',
  '/geo'                              => '/government/organisations/government-equalities-office',
  '/gla'                              => '/government/organisations/gangmasters-licensing-authority',
  '/gps'                              => '/government/organisations/government-procurement-service',
  '/hca'                              => '/government/organisations/homes-and-communities-agency',
  '/highways'                         => '/government/organisations/highways-agency',
  '/hm-courts-tribunals'              => '/government/organisations/hm-courts-and-tribunals-service',
  '/hm-prison-service'                => '/government/organisations/hm-prison-service',
  '/hm-treasury'                      => '/government/organisations/hm-treasury',
  '/hmrc'                             => '/government/organisations/hm-revenue-customs',
  '/home-office'                      => '/government/organisations/home-office',
  '/home-office/staff-update'         => '/government/organisations/home-office/about/staff-update',
  '/hs2'                              => '/government/organisations/high-speed-two-limited',
  '/hsac'                             => '/government/organisations/hazardous-substances-advisory-committee',
  '/iaap'                             => '/government/organisations/independent-agricultural-appeals-panel',
  '/idab'                             => '/government/organisations/industrial-development-advisory-board',
  '/ilf'                              => '/government/organisations/independent-living-fund',
  '/insolvency-service'               => '/government/organisations/insolvency-service',
  '/ip-tribunal'                      => '/government/organisations/insolvency-practitioners-tribunal',
  '/ipo'                              => '/government/organisations/intellectual-property-office',
  '/ips'                              => '/government/organisations/identity-and-passport-service',
  '/irc'                              => '/government/organisations/insolvency-rules-committee',
  '/jfc'                              => '/government/organisations/joint-forces-command',
  '/judicial-ombudsman'               => '/government/organisations/judicial-appointments-and-conduct-ombudsman',
  '/land-registry'                    => '/government/organisations/hm-land-registry',
  '/law-commission'                   => '/government/organisations/law-commission',
  '/leader-commons'                   => '/government/organisations/the-office-of-the-leader-of-the-house-of-commons',
  '/leader-lords'                     => '/government/organisations/office-of-the-leader-of-the-house-of-lords',
  '/lpc'                              => '/government/organisations/low-pay-commission',
  '/lrrc'                             => '/government/organisations/land-registration-rule-committee',
  '/mac'                              => '/government/organisations/migration-advisory-committee',
  '/maib'                             => '/government/organisations/marine-accident-investigation-branch',
  '/mca'                              => '/government/organisations/maritime-and-coastguard-agency',
  '/mdpga'                            => '/government/organisations/ministry-of-defence-police-and-guarding-agency',
  '/mhra'                             => '/government/organisations/medicines-and-healthcare-products-regulatory-agency',
  '/mmo'                              => '/government/organisations/marine-management-organisation',
  '/mod'                              => '/government/organisations/ministry-of-defence',
  '/moj'                              => '/government/organisations/ministry-of-justice',
  '/monitor'                          => '/government/organisations/monitor',
  '/natural-england'                  => '/government/organisations/natural-england',
  '/ndnad-ethics'                     => '/government/organisations/national-dna-database-ethics-group',
  '/neab'                             => '/government/organisations/national-employer-advisory-board',
  '/nfa'                              => '/government/organisations/national-fraud-authority',
  '/nio'                              => '/government/organisations/northern-ireland-office',
  '/nctl'                             => '/government/organisations/national-college-for-teaching-and-leadership',
  '/nlfab'                            => '/government/organisations/nuclear-liabilities-financing-assurance-board',
  '/nmo'                              => '/government/organisations/national-measurement-office',
  '/noms'                             => '/government/organisations/national-offender-management-service',
  '/nrac'                             => '/government/organisations/nuclear-research-advisory-council',
  '/nsandi'                           => '/government/organisations/national-security',
  '/number10'                         => '/government/organisations/prime-ministers-office-10-downing-street',
  '/oag'                              => '/government/organisations/office-of-the-advocate-general-for-scotland',
  '/oda'                              => '/government/organisations/olympic-delivery-authority',
  '/office-for-life-sciences'         => '/government/organisations/office-for-life-sciences',
  '/ofqual'                           => '/government/organisations/office-of-qualifications-and-examinations-regulation',
  '/ofsted'                           => '/government/organisations/ofsted',
  '/ofwat'                            => '/government/organisations/the-water-services-regulation-authority',
  '/oisc'                             => '/government/organisations/office-of-the-immigration-services-commissioner',
  '/old'                              => '/government/organisations/olympic-lottery-distributor',
  '/olev'                             => '/government/organisations/office-for-low-emission-vehicles',
  '/ome'                              => '/government/organisations/office-of-manpower-economics',
  '/opa'                              => '/government/organisations/oil-and-pipelines-agency',
  '/opg'                              => '/government/organisations/office-of-the-public-guardian',
  '/ospt'                             => '/government/organisations/official-solicitor-and-public-trustee',
  '/pabew'                            => '/government/organisations/police-advisory-board-for-england-and-wales',
  '/parole-board'                     => '/government/organisations/parole-board',
  '/phe'                              => '/government/organisations/public-health-england',
  '/pins'                             => '/government/organisations/planning-inspectorate',
  '/planning-inspectorate'            => '/government/organisations/planning-inspectorate',
  '/police-appeals'                   => '/government/organisations/police-discipline-appeals-tribunal',
  '/police-arbitration'               => '/government/organisations/police-arbitration-tribunal',
  '/probation-trusts'                 => '/government/organisations/probation-trusts',
  '/psrb'                             => '/government/organisations/prison-services-pay-review-body',
  '/public-standards'                 => '/government/organisations/the-committee-on-standards-in-public-life',
  '/pvst'                             => '/government/organisations/plant-varieties-and-seeds-tribunal',
  '/raib'                             => '/government/organisations/rail-accidents-investigation-branch',
  '/rbgc'                             => '/government/organisations/review-board-for-government-contracts',
  '/rmac'                             => '/government/organisations/royal-mint-advisory-committee',
  '/royal-mint'                       => '/government/organisations/royal-mint',
  '/rpa'                              => '/government/organisations/rural-payments-agency',
  '/sac'                              => '/government/organisations/science-advisory-council',
  '/sascmill'                         => '/government/organisations/science-advisory-committee-on-the-medical-implications-of-less-lethal-weapons',
  '/sce'                              => '/government/organisations/service-children-s-education',
  '/scotland-office'                  => '/government/organisations/scotland-office',
  '/sfa'                              => '/government/organisations/skills-funding-agency',
  '/smcpc'                            => '/government/organisations/social-mobility-and-child-poverty-commission',
  '/spva'                             => '/government/organisations/service-personnel-and-veterans-agency',
  '/ssrb'                             => '/government/organisations/review-body-on-senior-salaries',
  '/sta'                              => '/government/organisations/standards-and-testing-agency',
  '/strb'                             => '/government/organisations/school-teachers-review-body',
  '/svap'                             => '/government/organisations/security-vetting-appeals-panel',
  '/tab'                              => '/government/organisations/technical-advisory-board',
  '/teaching-agency'                  => '/government/organisations/national-college-for-teaching-and-leadership',
  '/tpc'                              => '/government/organisations/tribunal-procedure-committee',
  '/traffic-commissioners'            => '/government/organisations/traffic-commissioners',
  '/transport'                        => '/government/organisations/department-for-transport',
  '/treasure-valuation'               => '/government/organisations/treasure-valuation-committee',
  '/treasury'                         => '/government/organisations/hm-treasury',
  '/trust-ports'                      => '/government/organisations/trust-ports',
  '/tsb'                              => '/government/organisations/technology-strategy-board',
  '/tsol'                             => '/government/organisations/treasury-solicitor-s-department',
  '/uk-export-finance'                => '/government/organisations/uk-export-finance',
  '/uk-space'                         => '/government/organisations/uk-space-agency',
  '/ukaea'                            => '/government/organisations/uk-atomic-energy-authority',
  '/ukba'                             => '/government/organisations/uk-border-agency',
  '/ukces'                            => '/government/organisations/uk-commission-for-employment-and-skills',
  '/ukfi'                             => '/government/organisations/uk-financial-investments-limited',
  '/ukho'                             => '/government/organisations/uk-hydrographic-office',
  '/ukti'                             => '/government/organisations/uk-trade-investment',
  '/vapc'                             => '/government/organisations/veterans-advisory-and-pensions-committees-x13',
  '/vca'                              => '/government/organisations/vehicle-certification-agency',
  '/victims-commissioner'             => '/government/organisations/victims-commissioner',
  '/vmd'                              => '/government/organisations/veterinary-medicines-directorate',
  '/voa'                              => '/government/organisations/valuation-office-agency',
  '/vosa'                             => '/government/organisations/vehicle-and-operator-services-agency',
  '/vpc'                              => '/government/organisations/veterinary-products-committee',
  '/wales-office'                     => '/government/organisations/wales-office',
  '/yjb'                              => '/government/organisations/youth-justice-board-for-england-and-wales',

  # Inside Government specific World Locations
  '/world'                              => '/government/world',
  '/world/bat'                          => '/government/world/british-antarctic-territory',
  '/world/bosnia-herzegovina'           => '/government/world/bosnia-and-herzegovina',
  '/world/cotedivoire'                  => '/government/world/cote-d-ivoire',
  '/world/council-of-europe'            => '/government/world/uk-delegation-to-council-of-europe',
  '/world/jerusalem'                    => '/government/world/the-occupied-palestinian-territories',
  '/world/oecd'                         => '/government/world/the-uk-permanent-delegation-to-the-oecd-organisation-for-economic-co-operation-and-development',
  '/world/osce'                         => '/government/world/uk-delegation-to-organization-for-security-and-co-operation-in-europe',
  '/world/southafrica'                  => '/government/world/south-africa',
  '/world/uk-eu'                        => '/government/world/uk-representation-to-the-eu',
  '/world/uk-nato'                      => '/government/world/uk-joint-delegation-to-nato',
  '/world/un-geneva'                    => '/government/world/uk-mission-to-the-un-geneva',
  '/world/un-newyork'                   => '/government/world/uk-mission-to-the-united-nations-new-york',
  '/world/un-vienna'                    => '/government/world/uk-mission-to-the-united-nations',


  # Government department promoted publications - Inside Government
  '/dft/hs2'                      => '/government/policies/developing-a-new-high-speed-rail-network',
  '/decc/green-deal-quick-guides' => '/government/organisations/department-of-energy-climate-change/series/green-deal-quick-guides',
  '/bis/industrial-strategy'      => '/government/policies/using-industrial-strategy-to-help-the-uk-economy-and-business-compete-and-grow',

  # topical events (Olympics, G8 etc.)
  '/g8'                    => '/government/topical-events/g8-2013',
  '/somaliaconference2013' => '/government/topical-events/somalia-conference-2013',
  '/friendsofyemen2013'    => '/government/topical-events/friends-of-yemen-2013',
  '/ww1centenary'          => '/government/topical-events/first-world-war-centenary',

  # Direct request from Number 10 - Inside Government
  '/scotlandanalysis' => '/government/organisations/scotland-office/series/scotland-analysis',

  # These rewrites are caused by content being relocated. They should be
  # amended by the person moving the content.
  '/additional-paternity-leave-pay-employees'           => '/employers-additional-paternity-pay-leave',
  '/additionalstatepension'                             => '/additional-state-pension',
  '/apply-renew-passport-abroad'                        => '/overseas-passports',
  '/applynationalinsurancenumber'                       => '/apply-national-insurance-number',
  '/arrest-imprison-abroad'                             => '/help-if-you-are-arrested-abroad',
  '/benefitsadviser'                                    => '/benefits-adviser',
  '/bmdcertificates'                                    => '/order-copy-birth-death-marriage-certificate',
  '/browse/births-deaths-marriages/registry-offices'    => '/browse/births-deaths-marriages/register-offices',
  '/browse/citizenship/passports'                       => '/browse/abroad/passports',
  '/browse/driving/passports-travelling-abroad'         => '/browse/abroad',
  '/business-event-finder'                              => '/events-finder',
  '/business-training-and-networking-events-near-you'   => '/events-finder',
  '/calculate-child-maintenance'                        => '/calculate-your-child-maintenance',
  '/car-tax-disc-vehicle-licence'                       => '/tax-disc',
  '/change-name-address-vehicle-reg-certificate-v5c'    => '/change-name-address-v5c',
  '/change-photo-driving-licence'                       => '/renew-driving-licence',
  '/child-support-agency-employer-helpline'             => '/child-support-agency',
  '/community-legal-advice'                             => '/civil-legal-advice',
  '/complain-about-a-bankrupt'                          => '/complain-about-someone-bankrupt',
  '/copyofpolicerecords'                                => '/copy-of-police-records',
  '/council-tax-reduction/overview'                     => '/council-tax-reduction',
  '/criminal-records-bureau'                            => '/disclosure-barring-service',
  '/driving-licence-application-identity-documents'     => '/id-for-driving-licence',
  '/driving-theory-practical-test-fees'                 => '/driving-test-cost',
  '/employer-direct-online'                             => '/advertise-job',
  '/energyhelp'                                         => '/energy-grants-calculator',
  '/enterprisefinanceguarantee'                         => '/understanding-the-enterprise-finance-guarantee',
  '/exchange-paper-driving-licence-photocard-licence'   => '/exchange-paper-driving-licence',
  '/expenses-and-benefits-prizes-cash-prizes'           => '/expenses-and-benefits-cash-prizes',
  '/familyhistory'                                      => '/research-family-history',
  '/femalegenitalmutilation'                            => '/female-genital-mutilation',
  '/find-your-national-insurance-number-if-its-lost'    => '/lost-national-insurance-number',
  '/findlostpension'                                    => '/find-lost-pension',
  '/fire-rescue-services'                               => '/financial-help-after-fire',
  '/forecasting-finances'                               => '/forecast-business-finances',
  '/foreign-and-commonwealth-office-travel-advice'      => '/foreign-travel-advice',
  '/freight-forwarders'                                 => '/freight-forwarding-moving-goods',
  '/government/people/michael-spur'                     => '/government/people/michael-spurr',
  '/government/people/rita-kabaria-french'              => '/government/people/rita-french',
  '/government/topical-events/friends-of-yemen'         => '/government/topical-events/friends-of-yemen-2013',
  '/government/topical-events/somalia-conference'       => '/government/topical-events/somalia-conference-2013',
  '/government/world/jerusalem'                         => '/government/world/the-occupied-palestinian-territories',
  '/growing-a-business'                                 => '/growing-your-business',
  '/importing-live-fish-molluscs-and-crustacea'         => '/importing-and-exporting-live-fish-molluscs-and-crustacea',
  '/increase-state-pension-age'                         => '/changes-state-pension',
  '/jobs-jobsearch'                                     => '/jobsearch',
  '/jobseeker-direct'                                   => '/jobsearch',
  '/legal-aid-eligibility-calculator'                   => '/check-legal-aid',
  '/lostnationalinsurancenumber'                        => '/lost-national-insurance-number',
  '/marriage-overseas'                                  => '/marriage-abroad',
  '/national-insurance-number'                          => '/apply-national-insurance-number',
  '/non-native-crayfish-and-lobster-deposits'           => '/non-native-fish-and-shellfish',
  '/non-native-fish'                                    => '/non-native-fish-and-shellfish',
  '/personal-independence-payment'                      => '/pip',
  '/professional-and-career-development-loan-helpline'  => '/career-development-loans',
  '/regionalgrowthfund'                                 => '/regional-growth-fund-a-guide-for-small-and-medium-enterprises-smes',
  '/renew-your-driving-licence-if-you-are-70-or-over'   => '/renew-driving-licence-at-70',
  '/replace-child-trust-fund-voucher'                   => '/child-trust-funds',
  '/research-family-history-general-register-office'    => '/research-family-history',
  '/student-finance-evidence'                           => '/apply-for-student-finance',
  '/student-finance-evidence-from-parents-partners'     => '/apply-for-student-finance',
  '/tell-us-once-report-death'                          => '/after-a-death',
  '/time-off-employment-hearing-tribunal'               => '/employment-tribunals/going-to-a-tribunal-hearing',
  '/track-your-passport-application'                    => '/track-passport-application',
  '/which-finance'                                      => '/which-finance-is-right-for-your-business',
  '/who-can-sign-passport-driving-licence-applications' => '/countersigning-passport-applications',

  # separate alignment rules for massive URLs to follow
  '/accredited-electrical-and-electronic-equipment-producer-compliance-scheme-england-wales' => '/approved-eee-producer-compliance-scheme-england-wales',
  '/government/policies/stimulating-private-sector-investment-to-create-the-best-broadband-network-in-europe-by-2015' => '/government/policies/transforming-uk-broadband',
  '/service-manual/making-software/open-standards-and-licencing.html' => '/service-manual/making-software/open-standards-and-licensing.html',
  '/government/policies/providing-versatile-agile-and-battle-winning-armed-forces-and-a-smaller-more-professional-ministry-of-defence/supporting-pages/the-armed-forces-covenant' => '/government/policies/fulfilling-the-commitments-of-the-armed-forces-covenant',
  '/government/organisations/the-deputy-prime-ministers-office'      => '/government/organisations/deputy-prime-ministers-office',
  '/government/organisations/the-prime-ministers-office-number-10'   => '/government/organisations/prime-ministers-office-10-downing-street',
  '/government/organisations/export-credit-guarantee-department'     => '/government/organisations/uk-export-finance',
  '/government/organisations/teaching-agency'                        => '/government/organisations/national-college-for-teaching-and-leadership',
  '/government/organisations/national-college-for-school-leadership' => '/government/organisations/national-college-for-teaching-and-leadership',

}

prefix_redirects = {
  # These rewrites are caused by content being relocated. They should be
  # amended by the person moving the content.
  '/24_advanced_learning_loans'                             => '/advanced-learning-loans',
  '/adoption-leave'                                         => '/adoption-pay-leave',
  '/adoption-leave-pay-employees'                           => '/employers-adoption-pay-leave',
  '/adoptionpay'                                            => '/statutory-adoption-pay',
  '/apply-council-tax-benefit'                              => '/apply-council-tax-reduction',
  '/arranging-child-maintenance-child-support-agency'       => '/child-maintenance',
  '/boost-state-pension'                                    => '/national-insurance-credits',
  '/childmaintenance'                                       => '/child-maintenance',
  '/childtrustfund'                                         => '/child-trust-funds',
  '/council-tax-benefit'                                    => '/council-tax-reduction',
  '/crb-criminal-records-bureau-check'                      => '/disclosure-barring-service-check',
  '/disabilitywork'                                         => '/looking-for-work-if-disabled',
  '/driving-if-disabled'                                    => '/driving-medical-conditions',
  '/driving-in-great-britain-on-non-gb-licence'             => '/non-gb-driving-licence',
  '/expenses-and-benefits-sporting-recreational-facilities' => '/expenses-benefits-sporting-recreational-facilities',
  '/feed-in-tarriffs-money-for-generating-electricity'      => '/feed-in-tariffs',
  '/find-family-information-service'                        => '/find-registered-childminder',
  '/find-vosa-test-station'                                 => '/find-atf-vosa-test-station',
  '/find-your-nearest-vosa-test-station'                    => '/find-atf-vosa-test-station',
  '/looking-for-work-if-youre-disabled'                     => '/looking-for-work-if-disabled',
  '/make-child-maintenance-deductions-employee-pay'         => '/child-maintenance-for-employers',
  '/maternity-benefits'                                     => '/calculate-your-maternity-pay',
  '/maternity-leave'                                        => '/maternity-pay-leave',
  '/maternity-leave-pay-employees'                          => '/employers-maternity-pay-leave',
  '/nationalinsurancecredits'                               => '/national-insurance-credits',
  '/organise-fete-street-party'                             => '/organise-street-party',
  '/paternity-leave-pay-employees'                          => '/employers-paternity-pay-leave',
  '/paternity-pay'                                          => '/paternity-pay-leave',
  '/paternityleave'                                         => '/paternity-pay-leave',
  '/pensioncredit'                                          => '/pension-credit',
  '/sick-leave-pay-employees'                               => '/employers-sick-pay',
  '/sickpay'                                                => '/statutory-sick-pay',
  '/startup'                                                => '/starting-up-a-business',
  '/statepension'                                           => '/state-pension',
  '/statutory-adoption-pay'                                 => '/adoption-pay-leave',
  '/statutory-maternity-pay'                                => '/maternity-pay-leave',
  '/statutory-sick-pay-ssp'                                 => '/statutory-sick-pay',
  '/uk-welcomes-business'                                   => '/set-up-business-uk',
  '/voluntarynationalinsurance'                             => '/voluntary-national-insurance-contributions',
  '/your-right-to-minimum-wage'                             => '/national-minimum-wage',
}
%>

# World Location regular expression
location /world/ {
  rewrite ^/world/([a-z0-9-]+)$ /government/world/$1 permanent;
}

<%- external_redirects.each do |from, to| -%>
location ~ ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 302 <%= to %>;
}
<%- end -%>

<%- internal_redirects.each do |from, to| -%>
location ~ ^<%= from %>/?$ {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>;
}
<%- end -%>

<%- prefix_redirects.each do |from, to| -%>
location ~ ^<%= from %>($|/.*) {
  expires 1d;
  add_header cache-control 'public';
  return 301 <%= to %>$1;
}
<%- end -%>

location @upstream {
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/? {
  proxy_intercept_errors off;

  # Set proxy timeout to 50 seconds as a quick fix for problems
  # where civica QueryPayments calls are taking too long.
  proxy_read_timeout 50;
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/assets/ {
  limit_req zone=rate burst=5 nodelay;
  limit_conn connections 25;
  proxy_pass http://varnish;
}

location ~ ^/performance/graphs/ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}
location ~ ^/performance/.+\.(json|png)$ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}

# Akamai CDN test object. This file is used by Akamai's infrastructure to
# determine optimal routing within their network. It can be any text file
# 8-12KiB in size.
location = /__testobj__ {
  root /var/www;
  try_files /akamai_test_object.txt =404;
}

location / {
  root /var/www/fallback;

  <%- if @vhost_protected -%>

      deny all;
      auth_basic            "Enter the GOV.UK username/password (not your personal username/password)";
      auth_basic_user_file  /etc/govuk.htpasswd;
      satisfy any;

  <%- end -%>

  try_files /fallback.html @upstream;
}

error_page 404 401 /404.html;
error_page 406 /406.html;
error_page 410 /410.html;
error_page 418 /418.html;
error_page 500 502 /500.html;
error_page 503 /503.html;
error_page 504 /504.html;

location /404.html {
  root /usr/share/nginx/www;
  internal;
}
location /406.html {
  root /usr/share/nginx/www;
  internal;
}
location /410.html {
  root /usr/share/nginx/www;
  internal;
}
location /418.html {
  root /usr/share/nginx/www;
  internal;
}
location /500.html {
  root /usr/share/nginx/www;
  internal;
}
location /503.html {
  root /usr/share/nginx/www;
  internal;
}
location /504.html {
  root /usr/share/nginx/www;
  internal;
}
