keepalive_timeout 120;

proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-Server $host;
proxy_set_header X-Forwarded-Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_redirect off;

# This sets the IP used by Nginx to the client IP from the X-Forwarded-For
# chain, rather than the IP from the CDN node
real_ip_header X-Forwarded-For;
real_ip_recursive on;
set_real_ip_from 0.0.0.0/0;

# With the above real-ip in place we can limit connections and requests
# based on that
limit_req zone=rate burst=5 nodelay;
limit_conn connections 4;

proxy_read_timeout 10;

access_log /var/log/nginx/lb-access.log timed_combined;
error_log  /var/log/nginx/lb-error.log;

<%- if @platform != 'production' -%>
deny all;
auth_basic            "Enter your betademo password";
auth_basic_user_file  /etc/govuk.htpasswd;
satisfy any;
<%- end -%>

# These redirects to external URLs are a last resort for any given problem. Any additions should be cleared with Etienne
# They are recorded here as well for those without access to GitHub
# https://docs.google.com/a/digital.cabinet-office.gov.uk/document/d/1DJeKKnhmfQVJWhlwn0M7R5hSFy7t0kz-VJn2FqNSc7Y/edit
rewrite ^/cloudstore/?$ http://gcloud.civilservice.gov.uk/cloudstore/;
rewrite ^/digitalstrategy/?$ http://publications.cabinetoffice.gov.uk/digital/;
rewrite ^/performance/transactional-services/?$ http://transactionalservices.alphagov.co.uk/;
rewrite ^/support/internal/?$ https://support.<%= @app_domain %>/;

# These rewrites (FURLS) are for the purposes of URL Shortening. As of 2012-11-14 the process for adding this has not yet been clarified. If in doubt, check with your Tech Arch.
rewrite ^/studentfinance/?$ /student-finance permanent;
rewrite ^/jobsearch/?$ /jobs-jobsearch permanent;
rewrite ^/greendeal/?$ /green-deal-energy-saving-measures permanent;
rewrite ^/green-deal/?$ /green-deal-energy-saving-measures permanent;
rewrite ^/child-maintenance/?$ /calculate-child-maintenance permanent;
rewrite ^/childmaintenance/?$ /calculate-child-maintenance permanent;
rewrite ^/advancedlearningloans/?$ /24_advanced_learning_loans permanent;

# These rewrites are caused by content being relocated. They should be amended by the person moving the content.
rewrite ^/growing-a-business/?$ /growing-your-business permanent;
rewrite ^/tell-us-once-report-death/?$ /after-a-death permanent;
rewrite ^/browse/births-deaths-marriages/registry-offices/?$ /browse/births-deaths-marriages/register-offices permanent;
rewrite ^/employer-direct-online /advertise-job permanent;
rewrite ^/jobseeker-direct /jobs-jobsearch permanent;
# End rewrites

location @upstream {
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/ {
  proxy_intercept_errors off;

  # Set proxy timeout to 50 seconds as a quick fix for problems
  #Â where civica QueryPayments calls are taking too long.
  # 50s is max beccause that's what haproxy is configured at
  proxy_read_timeout 50;
  proxy_pass http://varnish;
}

location ~ ^/apply-for-a-licence/assets/ {
  limit_req zone=rate burst=5 nodelay;
  limit_conn connections 25;
  proxy_pass http://varnish;
}

location ~ ^/performance/graphs/ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}
location ~ ^/performance/.+\.(json|png)$ {
  limit_req zone=rate burst=25 nodelay;
  proxy_pass http://varnish;
}

# Start Inside Gov password logic:
#
# This whole government block is so we can hide the remaining undeployed parts
# of Inside Gov.
location ~ ^/government/world(/|$) {
  # XXX: If you remove this password control remove the cache control below too!
  deny all;
  auth_basic           "This part of INSIDE GOVERNMENT is not currently public. Government employees please login:";
  auth_basic_user_file /etc/govuk.htpasswd;
  satisfy any;
  proxy_pass http://varnish;

  # This is for Akamai and is part of the password above: If you remove the
  # passwd, remove this cache control as well!
  add_header cache-control no-cache;
}
# End Inside Gov password logic

# Akamai CDN test object. This file is used by Akamai's infrastructure to
# determine optimal routing within their network. It can be any text file
# 8-12KiB in size.
location = /__testobj__ {
  root /var/www;
  try_files /akamai_test_object.txt =404;
}

location / {
  root /var/www/fallback;
  try_files /fallback.html /flatsite/$uri /flatsite/$uri.html /flatsite/$uri/ /flatsite/$uri.1.html /flatsite/$uri/index.html /flatsite/index.html @upstream;
}

error_page 404 401 /404.html;
error_page 406 /406.html;
error_page 410 /410.html;
error_page 418 /418.html;
error_page 500 502 /500.html;
error_page 503 /503.html;
error_page 504 /504.html;

location /404.html {
  root /usr/share/nginx/www;
  internal;
}
location /406.html {
  root /usr/share/nginx/www;
  internal;
}
location /410.html {
  root /usr/share/nginx/www;
  internal;
}
location /418.html {
  root /usr/share/nginx/www;
  internal;
}
location /500.html {
  root /usr/share/nginx/www;
  internal;
}
location /503.html {
  root /usr/share/nginx/www;
  internal;
}
location /504.html {
  root /usr/share/nginx/www;
  internal;
}
