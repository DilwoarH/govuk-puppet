upstream varnish {
  # FIXME: https://www.pivotaltracker.com/story/show/44377213
  # Review when upgrading packages from:
  #
  #   - 1.2.4-2ubuntu0ppa4~lucid
  #   - 1.2.4-2ubuntu0ppa1~precise
  #
  # Despite documentation to the contrary, Lucid allows a request to be
  # retried twice when there is a single upstream server. Based on
  # proxy_next_upstream and proxy_read_timeout
  #
  # Precise does not, which is as expected, but not as desireable.Allow it
  # to match the behaviour of Lucid by specifying an additional server.
  # max_fails=0 should prevent it ever from being removed from rotation.
  server localhost:7999 max_fails=0;
<% unless @lsbdistcodename == 'lucid' -%>
  server localhost:7999 max_fails=0;
<% end -%>
}

server {
  server_name www.gov.uk www.<%= @app_domain %> www-origin.<%= @app_domain %>;
  listen 80;
  rewrite ^/(.*) https://$host/$1 permanent;
}

server {
  server_name         www.gov.uk;
  listen              443 ssl;
  ssl_certificate     /etc/nginx/ssl/www.gov.uk.crt;
  ssl_certificate_key /etc/nginx/ssl/www.gov.uk.key;
  include             /etc/nginx/ssl.conf;

  include             /etc/nginx/router_routes.conf;
}

server {
  server_name         www.<%= @app_domain %> www-origin.<%= @app_domain %>;
  listen              443 ssl;
  ssl_certificate     /etc/nginx/ssl/www.<%= @app_domain %>.crt;
  ssl_certificate_key /etc/nginx/ssl/www.<%= @app_domain %>.key;
  include             /etc/nginx/ssl.conf;

  include             /etc/nginx/router_routes.conf;
}
