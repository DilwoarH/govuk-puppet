# This file is managed by Puppet. Local changes will be clobbered.

<%- if platform != 'development' -%>
server {
  server_name <%= vhost %>;
  listen 80;
  rewrite ^/(.*) https://$server_name/$1 permanent;
}
<%- end -%>

server {
  server_name <%= vhost %>;

  <%- if platform == 'development' -%>
  listen 80;
  <%- else -%>
  listen              443 ssl;
  ssl_certificate     /etc/nginx/ssl/<%= vhost %>.crt;
  ssl_certificate_key /etc/nginx/ssl/<%= vhost %>.key;
  include             /etc/nginx/ssl.conf;
  <%- end -%>

  index index.php index.html;
  root /var/www/ganglia-web-3.5.0;

  access_log /var/log/nginx/<%= vhost %>-access.log timed_combined;
  error_log /var/log/nginx/<%= vhost %>-error.log;

  auth_basic "Ganglia Restricted Access";
  auth_basic_user_file /etc/govuk.htpasswd;

  location ~ \.php$ {
    include /etc/nginx/fastcgi_params;
    fastcgi_pass php;
  }

  location /views {
    alias /var/www/ganglia-views;
  }
}
