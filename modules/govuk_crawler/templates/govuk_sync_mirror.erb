#!/usr/bin/env bash
set -e

TARGETS="<%= @targets.flatten.join(' ') -%>"
MIRROR_ROOT="<%= @mirror_root -%>"
GOVUK_APP_DOMAIN=$(cat /etc/govuk/env.d/GOVUK_APP_DOMAIN)
STATIC_HOSTNAME="static.${GOVUK_APP_DOMAIN}"
PROGRAM_NAME=$(basename $0)

# Nagios defaults, assume failed
NAGIOS_CODE=1
NAGIOS_MESSAGE="WARNING: GOV.UK mirror synchronisation failed."

trap nagios_passive EXIT

if [ -z "${TARGETS}" ]; then
  log "user.info" "No mirror targets received"
fi

if [ ! -d "${MIRROR_ROOT}" ]; then
  log "user.info" "No mirror root specified or directory does not exist: ${MIRROR_ROOT}"
fi

if [ -z "${GOVUK_APP_DOMAIN}" ]; then
  log "user.info" "Couldn't find GOVUK_APP_DOMAIN"
fi

function nagios_passive() {
  logger -p user.info -t mirrorer $NAGIOS_MESSAGE Exit code was $?
  printf "<%= @fqdn %>\t<%= @service_desc %>\t${NAGIOS_CODE}\t${NAGIOS_MESSAGE}\n" | /usr/sbin/send_nsca -H alert.cluster >/dev/null
}

function get_error_page() {
  # Grab the 503 error page
  log "user.info" "Grabbing the latest error page"

  test -d ${MIRROR_ROOT}/error || mkdir ${MIRROR_ROOT}/error/
  curl -sf https://${STATIC_HOSTNAME}/templates/503.html.erb -o ${MIRROR_ROOT}/error/503.html
}

export MIRRORER_SITE_ROOT=https://www.gov.uk

logger -p user.info -t mirrorer Starting to mirror GOV.UK
/usr/local/bin/govuk_update_mirror
EXIT_CODE=$?
logger -p user.crit -t mirrorer Exit code from govuk_update_mirror was $EXIT_CODE
logger -p user.info -t mirrorer Finished the mirror of GOV.UK

# If we successfully ran govuk_update_mirror we need to update
# the assumed failure message to indicate it would be an
# upload failure.
if [ $EXIT_CODE == "0" ]; then
  NAGIOS_MESSAGE="WARNING: Mirrorer upload failed."
fi
get_error_page

logger -p user.info -t mirrorer Starting to upload GOV.UK to mirror targets
/usr/local/bin/govuk_upload_mirror
EXIT_CODE=$?
logger -p user.crit -t mirrorer Exit code from govuk_upload_mirror was $EXIT_CODE
logger -p user.info -t mirrorer Finished uploading GOV.UK to mirror targets

# As both scripts have succeeded then set the
# nagios code and message ot successful
if [ $EXIT_CODE == "0" ]; then
  NAGIOS_CODE=0
  NAGIOS_MESSAGE="OK: Mirrorer ran successfully."
fi
