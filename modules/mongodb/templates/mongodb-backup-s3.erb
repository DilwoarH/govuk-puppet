#!/bin/bash


BACKUP_NODE=<%= @backup_node %>
BACKUP_DIR=<%= @backup_dir %>
BACKUP_FILE=mongodump-<%= @fqdn %>.$(date +%F_%T).tar.gz.gpg
KEY_FINGERPRINT=<%= @private_gpg_key_fingerprint %>
S3_BUCKET=<%= @s3_bucket %>


exec 1> >(/usr/bin/logger -s -t $(basename $0)) 2>&1

function time_taken {
  TIME="$(date +%s)"
  $@
  TIME="$(($(date +%s)-TIME))"
  SECS="$((TIME))"
  printf " FINISHED IN: %02d:%02d:%02d\n" "$((SECS/3600%24))" "$((SECS/60%60))" "$((SECS%60))"

}


time_taken mongodump -h $BACKUP_NODE -o $BACKUP_DIR


TIME="$(date +%s)"
tar cvz $BACKUP_DIR | gpg -e -o $BACKUP_DIR/$BACKUP_FILE -r $KEY_FINGERPRINT
TIME="$(($(date +%s)-TIME))"
SECS="$((TIME))"
printf " FINISHED IN: %02d:%02d:%02d\n" "$((SECS/3600%24))" "$((SECS/60%60))" "$((SECS%60))"

export AWS_ACCESS_KEY_ID=<%= @aws_access_key_id %>
export AWS_SECRET_ACCESS_KEY=<%= @ws_secret_access_key %>

s3cmd put $BACKUP_DIR/mongodump-* s3://$S3_BUCKET

rm -f $BACKUP_DIR/mongodump-*


