#!/usr/bin/env bash
set -u

ICINGA_URL='https://nagios.cluster/cgi-bin/icinga/status.cgi?search_string=<%= @node_class_search_phrase %>&allunhandledproblems&jsonoutput'

if ! [ -f /var/run/reboot-required ]; then
  # No reboot required
  exit 0
fi

# Check that this machine is safe to reboot
if [ "$(govuk_setenv default printenv SAFE_TO_REBOOT)" != "yes" ]; then
  # Machine marked as not safe to reboot
  exit 0
fi

# Check for 'down' and 'unreachable' host alerts; 'critical' and 'warning' service alerts

check_icinga $ICINGA_URL

if [ $? -ne 0 ]; then
  echo 'Host or service alerts exist for node class, or Icinga unavailable'
  exit 1
fi

locksmithctl -endpoint='<%= @etcd_endpoint %>' lock '<%= @fqdn %>'

if [ $? -ne 0 ]; then
  echo "Couldn't obtain lock"
  exit 1
fi

reboot

if [ $? -ne 0 ]; then
  echo 'Reboot failed'
  exit 1
fi
