#!/bin/sh
TARGETS="<%= @targets.flatten.join(' ') -%>"

if [ -z "$TARGETS"]; then
  logger -t mirrorer empty target received for govuk mirror
fi

for TARGET in $TARGETS; do
  logger -t mirrorer Started uploading to $TARGET
  rsync -rLptgoD -z --delete /var/lib/govuk_mirror/current/. \
               $TARGET:/srv/mirror_data/www-origin
  EXITCODE=$?
  if [ "$EXITCODE" != "0" ]; then
     logger -p user.crit -t mirrorer Uploading mirror $TARGET failed with exit code: $EXITCODE
  fi
  logger -t mirrorer Finished uploading to mirror $TARGET
done
