#!/bin/sh
set -e

# /usr/local/bin isn't in the path for cron by default
PATH=$PATH:/usr/local/bin
export PATH

MIRROR_ROOT=/var/lib/govuk_mirror
TMP_ROOT=$(mktemp -d -t govuk_mirror.XXXXX)

cleanup () {
  rm -rf "$LOCK"
  rm -rf "$TMP_ROOT"
}
trap cleanup EXIT

cd "$TMP_ROOT"

DEST="${MIRROR_ROOT}/$(date "+%Y%m%dT%H%M%S")"

# Generate lists of URL's to mirror / blacklist
# Generates 2 files - whitelist_urls and blacklist_paths
govuk_content_indexer

# Mirror the site
#
# It is likely that wget will return a nonzero exit code, due to unauthorized
# endpoints or 406 responses, etc. We don't catch this error but ensure the
# mirrored website is of a reasonable size (>10MB) instead.
set +e
wget --mirror \
  --adjust-extension \
  -o mirror.log \
  -X /licence-finder,/trade-tariff,/business-finance-support-finder,/government \
  --header="X-Govuk-Mirrorer: 1" \
  -i whitelist_urls \
  https://www.gov.uk/
set -e

if [ ! "$(du -ks www.gov.uk | awk)" -gt "10000" ]; then
  echo "ERROR: Mirror appears to have failed (total size <10MB)" >> mirror.log
  echo "ERROR: Not updating 'current' symlink" >> mirror.log
  mv mirror.log "$DEST.log"
  exit 1
fi

# Delete any mirrored items that won't work on a static site.
# The blacklist_paths file, generated by the govuk_content_indexer call above,
while read line; do
  rm -rf "www.gov.uk${line}"
  rm -f "www.gov.uk${line}.*"
done < blacklist_paths

mv www.gov.uk "$DEST"
mv mirror.log "$DEST.log"
mv whitelist_urls "$DEST.whitelist_urls"
mv blacklist_paths "$DEST.blacklist_paths"

# Clean up all but the last 7 mirror versions
find "$MIRROR_ROOT" -mindepth 1 -maxdepth 1 -type d |
  sort -r |
  tail -n +8 |
  while read dir; do
    rm -rf "$dir"
    rm "${dir}.log"
  done

# Update symlink to latest version
ln -snf "$DEST" "${MIRROR_ROOT}/current"
