description "GOV.UK Logstream: Application Logging"

# ideally we'd use the "manual" stanza to disable job startup in
# development, but this stanza was only added in upstart 0.6.7 and
# lucid runs upstart 0.6.5.
start on runlevel [2345]
stop on runlevel [!2345]

respawn

# If the app respawns more than 5 times in 20 seconds, it has deeper problems
# and should be killed off.
respawn limit 5 20

# example:
# initctl start logstream LOG_FILE=/var/log/whitehall/upstart.err.log \
#                         TAG="whitehall UPSTART STDERR"
#
# LOG_FILE: specify the location of log file to be tailed
# TAG: should be a string of tags to tag a log line with me
instance "<%= @logfile %>"

<%
logpipe_args = []
logpipe_args << "--json" if @json.to_s == 'true'
logpipe_args += ["-t", @tag_string] unless @tag_string.empty?
logpipe_args += ["-f", "host=#{@host}"]
logpipe_args += @fields.map { |k,v| "#{k}=#{v}" }
-%>
script
    tail -F <%= @logfile %> | govuk_logpipe <%= logpipe_args.join(" ") %>
end script
