input {
  file {
    type => "<%= @title %>-app-out"
    path => "/var/log/<%= @title %>/app.out.log"
  }
  file {
    type => "<%= @title %>-app-err"
    path => "/var/log/<%= @title %>/app.err.log"
  }
  file {
    type => "<%= @title %>-upstart-out"
    path => "/var/log/<%= @title %>/upstart.out.log"
  }
  file {
    type => "<%= @title %>-upstart-err"
    path => "/var/log/<%= @title %>/upstart.err.log"
  }
  file {
    type => "<%= @title %>-app"
    path => "/var/apps/<%= @title %>/log/*.log"
  }
  file {
    type => "<%= @title %>-nginx-access"
    path => "/var/log/nginx/<%= @vhost_full %>-access.log"
  }
  file {
    type => "<%= @title %>-nginx-error"
    path => "/var/log/nginx/<%= @vhost_full %>-error.log"
  }
}

filter {
  grok {
    type => "<%= @title %>-nginx-access"
    pattern => '%{IPORHOST:clientip} %{USER:ident} %{USER:auth} \[%{HTTPDATE:timestamp}\]  "(?:%{WORD:verb} %{URIPATHPARAM:request}(?: HTTP/%{NUMBER:httpversion})?|-)" %{NUMBER:response} (?:%{NUMBER:bytes}|-) "(?:%{URI:referrer}|-)" %{QS:agent} %{NUMBER:request_time} %{NUMBER:upstream_response_time} %{NUMBER:gzip_ratio} (?:%{WORD:cache_hit}|-)%{GREEDYDATA}'
    add_tag => [ "nginx" ]
  }
  grok {
    pattern => "%{WORD:method}%{SPACE}%{DATA}%{SPACE}action=%{WORD:controller}#%{WORD:action}%{SPACE}status=%{INT:status}%{SPACE}duration=%{NUMBER:duration}%{SPACE}view=%{NUMBER:view}%{GREEDYDATA}"
    type => "<%= @title %>-app"
    add_tag => [ "lograge" ]
  }
}

output {
  statsd {
    host => 'localhost'
    tags => [ "lograge" ]
    timing => [ "<%= @title %>.%{controller}.%{action}.%{method}.duration", "%{duration}" ]
  }
  statsd {
    host => 'localhost'
    tags => [ "lograge" ]
    timing => [ "<%= @title %>.%{controller}.%{action}.%{method}.view", "%{view}" ]
  }
  statsd {
    host => 'localhost'
    tags => [ "nginx" ]
    increment => "nginx.response.%{verb}.%{response}"
    count => [ "nginx.bytes", "%{bytes}" ]
  }
}
