[nginx_access-default]
type = "LogstreamerInput"
log_directory = "/var/log/nginx"
file_match = 'json\.event\.access\.log\.?(?P<Index>\d+)?(\.gz)?'
differentiator = ["default"]
priority = ["^Index"]
decoder = "nginx_access_decoder"
hostname = "<%= @fqdn_underscore -%>"

[nginx_access-vhosts]
type = "LogstreamerInput"
log_directory = "/var/log/nginx"
file_match = '(?P<LogBasename>.+)-json\.event\.access\.log\.?(?P<Index>\d+)?(\.gz)?'
differentiator = ["LogBasename"]
priority = ["^Index"]
decoder = "nginx_access_decoder"
hostname = "<%= @fqdn_underscore -%>"

[nginx_access_decoder]
type = "SandboxDecoder"
filename = "lua_decoders/json_event.lua"

[nginx_access_decoder.config]
type = "nginx.access"


[nginx_error-default]
type = "LogstreamerInput"
log_directory = "/var/log/nginx"
file_match = 'error\.log\.?(?P<Index>\d+)?(\.gz)?'
differentiator = ["default", "-error"]
priority = ["^Index"]
decoder = "nginx_error_decoder"
hostname = "<%= @fqdn_underscore -%>"

[nginx_error-vhosts]
type = "LogstreamerInput"
log_directory = "/var/log/nginx"
file_match = '(?P<LogBasename>.+)-error\.log\.?(?P<Index>\d+)?(\.gz)?'
differentiator = ["LogBasename", "-error"]
priority = ["^Index"]
decoder = "nginx_error_decoder"
hostname = "<%= @fqdn_underscore -%>"

[nginx_error_decoder]
type = "SandboxDecoder"
filename = "lua_decoders/nginx_error.lua"

[nginx_error_decoder.config]
type = "nginx.error"

[NginxReqStats]
type = "SandboxFilter"
filename = "/usr/share/heka/lua_filters/http_req_stat_filter.lua"
message_matcher = 'Hostname == "<%= @fqdn_underscore -%>" && Type == "nginx.access" && Fields[request_time] != NIL && Fields[status] > 0'
ticker_interval = 5

[NginxReqStats.config]
# Yes, you have to put the same ticker_interval value in both places
ticker_interval = 5

# Log a useful error when a sandbox plugin crashes
[PayloadEncoder]
[LogOutput]
message_matcher = "Type == 'heka.sandbox-terminated'"
encoder = "PayloadEncoder"
