upstream ukba {
  server origin.ukba.homeoffice.gov.uk:80;
}

server {
  server_name www.ukba.homeoffice.gov.uk;
  server_name aka.ukba.homeoffice.gov.uk;
  server_name bia.homeoffice.gov.uk;
  server_name aka-bia.homeoffice.gov.uk;
  server_name ind.homeoffice.gov.uk;
  server_name aka-ind.homeoffice.gov.uk;
  server_name origin.ukba.homeoffice.gov.uk;
  server_name aka-origin.ukba.homeoffice.gov.uk;
  server_name ukba.homeoffice.gov.uk;
  server_name aka-ukba.homeoffice.gov.uk;
  server_name www.bia.homeoffice.gov.uk;
  server_name aka.bia.homeoffice.gov.uk;
  server_name www.ind.homeoffice.gov.uk;
  server_name aka.ind.homeoffice.gov.uk;
  listen 80;

  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-Server $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_connect_timeout 10s;
  proxy_read_timeout 15s; # /view/case_finder.form is often quite slow.

  access_log /var/log/nginx/www.ukba.homeoffice.gov.uk-access.log timed_combined;
  access_log /var/log/nginx/www.ukba.homeoffice.gov.uk-json.event.access.log json_event;
  error_log /var/log/nginx/www.ukba.homeoffice.gov.uk-error.log;

  <% $proxied_locations = [
      '/aboutus/informationformps',
      '~* /countries/[a-zA-Z\-]+/fees', # eg /countries/angola/fees or /countries/czech-republic/fees or /countries/japan/fees1/
      '/sitecontent/documents/aboutus/info-fact-sheet-mps',
      '/sitecontent/documents/aboutus/mps-enquiries',
      '/sitecontent/documents/aboutus/mps-family-visit',
      '/sitecontent/documents/aboutus/confirms-mp-enqline/',
      '/sitecontent/documents/aboutus/example-agenda-mp',
      '/sitecontent/documents/aboutus/perform-mp-service/',
      '/view/case_finder.form',         # POSTed to by the form at: /aboutus/informationformps/track-correspondence/
      '/visas-immigration/general-info/fees',
      '/visas-immigration/general-info/processing-times',
      '~* (/static/biaAssets/*|/images/*)', # We want to proxy page furniture so that the pages don't look broken. Includes RSS feeds like: /static/biaassets/rss/citizenshiprss.xml
    ]
  %>

  <% $proxied_locations.each do |proxied_location| %>
    location <%= proxied_location %> {
      proxy_pass http://ukba;
      # Can't use $http_host as that might be eg aka.ukba.homeoffice.gov.uk
      proxy_set_header Host www.ukba.homeoffice.gov.uk;
    }
  <% end %>

  # Fall back to Bouncer
  location / {
    proxy_pass http://<%= "bouncer.#{@app_domain}-proxy" %>;
    proxy_set_header Host $http_host;
  }
}
