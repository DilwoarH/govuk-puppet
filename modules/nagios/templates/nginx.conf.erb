# This file is managed by Puppet. Local changes will be clobbered.

<%- if @enable_ssl -%>
server {
  server_name <%= vhost %>;
  listen 80;
  rewrite ^/(.*) https://$host/$1 permanent;
}
<%- end -%>

server {
  server_name <%= vhost %>;

  <%- if !@enable_ssl -%>
  listen 80;
  <%- else -%>
  listen                    443 ssl;
  ssl_certificate           /etc/nginx/ssl/<%= vhost %>.crt;
  ssl_certificate_key       /etc/nginx/ssl/<%= vhost %>.key;
  proxy_set_header          X-Forwarded-Ssl on;
  ssl_protocols             TLSv1 SSLv3;
  ssl_ciphers               HIGH:!ADH:!kEDH;
  ssl_prefer_server_ciphers on;
  ssl_session_cache         shared:SSL:10m;
  ssl_session_timeout       5m;
  # max-age=31536000 commits us to using HSTS for one year
  add_header                Strict-Transport-Security "max-age=31536000";
  <%- end -%>

  index index.html;
  root /usr/share/nagios3/htdocs;

  access_log /var/log/nginx/<%= vhost %>-access.log timed_combined;
  error_log /var/log/nginx/<%= vhost %>-error.log;

  auth_basic "Nagios Restricted Access";
  auth_basic_user_file /etc/govuk.htpasswd;

  location /stylesheets {
    alias /etc/nagios3/stylesheets;
  }

  location ~ \.cgi$ {
    root /usr/lib/cgi-bin/nagios3;
    rewrite ^/cgi-bin/nagios3/(.*)$ /$1;

    include /etc/nginx/fastcgi_params;

    fastcgi_param AUTH_USER $remote_user;
    fastcgi_param REMOTE_USER $remote_user;
    fastcgi_param SCRIPT_FILENAME /usr/lib/cgi-bin/nagios3$fastcgi_script_name;

    fastcgi_pass fcgiwrap;
  }

}
